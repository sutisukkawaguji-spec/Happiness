<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Meter | Executive Intelligence</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --primary: #6c5ce7;
            --accent: #fd79a8;
        }
        body { background-image: var(--bg-gradient); font-family: 'Kanit', sans-serif; min-height: 100vh; color: #444; padding-bottom: 100px; overflow-x: hidden; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 24px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.6); }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏¢‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏ö */
        .thumb-item {
            position: relative;
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }
        .btn-remove-img {
            position: absolute; top: 2px; right: 2px;
            background: rgba(255, 0, 0, 0.8); color: white;
            border: none; border-radius: 50%; width: 20px; height: 20px;
            font-size: 12px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10;
        }
        .btn-remove-img:hover { background: red; }
        
        /* --- Profile & Aura --- */
        .profile-container { 
            position: relative; display: inline-block; 
            width: 100px; height: 100px; margin-bottom: 15px; z-index: 1;
        }
        
        .profile-img { 
            width: 90px !important; height: 90px !important;
            border-radius: 50%; border: 3px solid #fff; 
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5; object-fit: cover; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: #fff;
        }

        .aura-glow { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(var(--scale, 1)); 
            width: 110px; height: 110px; border-radius: 50%; z-index: 1; 
            filter: blur(15px); opacity: 0.8; transition: all 0.5s ease;
        }

        @keyframes pulse-slow { 
            0% { transform: translate(-50%, -50%) scale(var(--scale, 1)); opacity: 0.7; } 
            50% { transform: translate(-50%, -50%) scale(calc(var(--scale, 1) * 1.1)); opacity: 0.9; } 
            100% { transform: translate(-50%, -50%) scale(var(--scale, 1)); opacity: 0.7; } 
        }
        @keyframes rotate-aura { 
            0% { transform: translate(-50%, -50%) scale(var(--scale, 1)) rotate(0deg); } 
            100% { transform: translate(-50%, -50%) scale(var(--scale, 1)) rotate(360deg); } 
        }
        @keyframes god-mode { 
            0% { filter: blur(15px) hue-rotate(0deg); } 
            100% { filter: blur(25px) hue-rotate(360deg); } 
        }

        .aura-lv-1 { animation: pulse-slow 4s infinite; }
        .aura-lv-5 { animation: pulse-slow 2s infinite; filter: blur(18px); }
        .aura-lv-10 { animation: rotate-aura 10s linear infinite; filter: blur(20px); }
        .aura-lv-20 { animation: rotate-aura 5s linear infinite, god-mode 3s infinite alternate; }

        .aura-volunteer { background: radial-gradient(circle, #3498db 0%, transparent 70%); }
        .aura-sufficiency { background: radial-gradient(circle, #2ecc71 0%, transparent 70%); }
        .aura-discipline { background: radial-gradient(circle, #9b59b6 0%, transparent 70%); }
        .aura-integrity { background: radial-gradient(circle, #00cec9 0%, transparent 70%); }
        .aura-gratitude { background: radial-gradient(circle, #e84393 0%, transparent 70%); }
        .aura-none { background: #dfe6e9; opacity: 0.2; }

        /* Bars & UI */
        .power-bar-label { font-size: 0.75rem; font-weight: 600; color: #666; display: flex; justify-content: space-between; margin-bottom: 2px;}
        .progress { height: 8px; border-radius: 5px; background: #e0e0e0; margin-bottom: 10px; }
        .bar-happy { background: linear-gradient(90deg, #ffeaa7, #fdcb6e); }
        .bar-virtue { background: linear-gradient(90deg, #81ecec, #00cec9); }

        .mood-container { display: flex; justify-content: space-around; background: #fff; padding: 10px; border-radius: 20px; }
        .mood-btn { border: none; background: none; font-size: 2.2rem; opacity: 0.4; transition: 0.2s; filter: grayscale(1); }
        .mood-btn.active { opacity: 1; transform: scale(1.2); filter: grayscale(0); }
        
        .friend-list { max-height: 250px; overflow-y: auto; }
        .friend-item { display: flex; align-items: center; padding: 8px 12px; border-radius: 12px; background: #fff; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; user-select: none; }
        .friend-item:hover { transform: translateY(-2px); background-color: #f8f9fa; }
        .friend-item.selected { background: #fff; border-color: var(--primary); box-shadow: 0 2px 8px rgba(108, 92, 231, 0.2); }
        
        /* Feed */
        .feed-card { background: #fff; border-radius: 20px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .feed-header { display: flex; align-items: center; margin-bottom: 10px; }
        .feed-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 2px solid #f0f0f0; }
        .feed-img { width: 100%; border-radius: 12px; margin-bottom: 10px; display: block; object-fit: cover; max-height: 400px; background: #f8f9fa; cursor: pointer; }
        .feed-badge { background: rgba(108, 92, 231, 0.1); color: var(--primary); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
        .action-btn { color: #aaa; font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
        .action-btn:hover { color: var(--accent); }
        .action-btn.liked { color: #ff7675; }

        /* Dashboard */
        .stat-card { background: #fff; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-num { font-size: 1.5rem; font-weight: bold; }
        .staff-row { cursor: pointer; transition: 0.2s; border-left: 5px solid transparent; }
        .status-critical { border-left-color: #ff7675; background: rgba(255, 118, 117, 0.05); }
        .status-warning { border-left-color: #ffeaa7; background: rgba(255, 234, 167, 0.1); }
        .status-normal { border-left-color: #55efc4; }

        .img-preview-container { width: 100%; height: 200px; background-color: #f0f2f5; border-radius: 12px; margin-top: 10px; display: none; background-size: cover; background-position: center; border: 2px dashed #ccc; }
        .badge-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .badge-item { background: #fff; border-radius: 15px; padding: 15px 5px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 450px; background: #fff; border-radius: 50px; padding: 10px; display: flex; justify-content: space-between; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 999; }
        .nav-item { text-align: center; flex: 1; color: #ccc; cursor: pointer; font-size: 1.2rem; transition: 0.3s; padding: 5px; border-radius: 20px; }
        .nav-item.active { color: var(--primary); background: rgba(108, 92, 231, 0.1); }
        .nav-item span { display: block; font-size: 0.6rem; margin-top: 2px; }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .page-section { display: none; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .badge-mystery-upgrade { background: linear-gradient(135deg, #a8e063, #56ab2f); color: white; animation: shakeBox 2s infinite; border: 2px solid #fff; }
        @keyframes shakeBox { 0% { transform: rotate(0deg); } 25% { transform: rotate(2deg); } 75% { transform: rotate(-2deg); } 100% { transform: rotate(0deg); } }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</p>
</div>

<div class="container mt-3">

    <div id="header-user" class="glass-card text-center pb-2">
        <div class="row align-items-center">
            <div class="col-4">
                <div class="profile-container">
                    <div id="userAura" class="aura-glow aura-active"></div>
                    <img id="userImg" src="https://dummyimage.com/90x90/cccccc/ffffff&text=User" class="profile-img">
                </div>
            </div>
            <div class="col-8 text-start">
                <h4 id="userName" class="fw-bold mb-1">...</h4>
                <small id="userRole" class="text-muted d-block mb-2">...</small>
                <div class="power-bar-label"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç</span><i class="fas fa-bolt text-warning"></i></div>
                <div class="progress"><div class="progress-bar bar-happy" style="width: 80%"></div></div>
                <div class="power-bar-label"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</span><i class="fas fa-star text-info"></i></div>
                <div class="progress"><div class="progress-bar bar-virtue" style="width: 50%"></div></div>
            </div>
        </div>
    </div>

    <div id="page-record" class="page-section active">
        <div class="glass-card">
            <label class="form-label fw-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
            <div class="mood-container mb-3">
                <button class="mood-btn" onclick="setMood(1, this)">üòû</button>
                <button class="mood-btn" onclick="setMood(2, this)">üòê</button>
                <button class="mood-btn active" onclick="setMood(3, this)">üòÅ</button>
            </div>
            
            <label class="form-label fw-bold d-flex align-items-center">‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ <i class="fas fa-circle-question info-btn fa-lg" onclick="showVirtueInfo()"></i></label>
            <select class="form-select mb-3" id="virtueSelect" style="border-radius: 12px; height: 50px; font-weight: bold;">
                <option value="" disabled selected>‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ ‚Äî</option>
                <option value="volunteer" style="color:#00a8ff;">ü§ù ‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤ (Volunteer)</option>
                <option value="sufficiency" style="color:#44bd32;">üå± ‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á (Sufficiency)</option>
                <option value="discipline" style="color:#8c7ae6;">üìè ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ (Discipline)</option>
                <option value="integrity" style="color:#00cec9;">üíé ‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï (Integrity)</option>
                <option value="gratitude" style="color:#e84393;">üôè ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π (Gratitude)</option>
            </select>

            <div class="mb-3">
                <textarea class="form-control mb-2" rows="2" placeholder="‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤..." id="noteInput" style="border-radius: 12px;"></textarea>
                <div class="d-flex gap-2 overflow-auto pb-2">
                    <span class="badge bg-white text-dark border p-2" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                    <span class="badge bg-white text-dark border p-2" onclick="addEmoji('‚úåÔ∏è')">‚úåÔ∏è</span>
                    <span class="badge bg-white text-dark border p-2" onclick="addEmoji('üî•')">üî•</span>
                    <span class="badge bg-white text-dark border p-2" onclick="addEmoji('üôè')">üôè</span>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-outline-secondary w-100 rounded-3 mt-2" onclick="document.getElementById('fileCam').click()">
                        <i class="fas fa-camera me-2"></i>‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ)
                    </button>
                    <input type="file" id="fileCam" hidden accept="image/*" multiple onchange="handleFileSelect(this)">
                
                    <div id="thumbList" class="d-flex gap-2 mt-2 overflow-auto" style="white-space: nowrap;"></div>
                
                    <div id="previewArea" class="img-preview-container mt-2 position-relative">
                        <small class="text-muted position-absolute top-50 start-50 translate-middle pointer-events-none">
                            ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                        </small>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label fw-bold mb-0">‡∏ó‡∏≥‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£?</label>
                <button class="btn btn-sm btn-outline-primary rounded-pill px-3" id="btnSelectAll" onclick="selectAllFriends()"><i class="fas fa-check-double me-1"></i>All</button>
            </div>
            <div class="friend-list row" id="friendListArea"></div> 
            <button class="btn btn-primary w-100 py-3 rounded-4 shadow mt-3 fw-bold" onclick="submitData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</button>
        </div>
    </div>

    <div id="page-stories" class="page-section">
        <h5 class="fw-bold mb-3 px-2">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
        <div id="feedContainer" style="min-height: 200px;">
            <div class="text-center py-5 text-muted">
                <div class="spinner-border spinner-border-sm mb-2"></div><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß...
            </div>
        </div>
    </div>

    <div id="page-stats" class="page-section">
        <div class="glass-card text-center">
            <h5 class="fw-bold">‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏û‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h5>
            <div class="radar-wrapper">
                <canvas id="userRadarChart"></canvas>
            </div>
            <div id="statAnalysis" class="mt-2 p-3 rounded-4 border shadow-sm" style="transition: all 0.5s ease;">
                <h5 id="statTitle" class="fw-bold mb-2">...</h5>
                <p id="statDesc" class="small text-dark mb-0" style="opacity: 0.8;">...</p>
            </div>
        </div>
    </div>

    <div id="page-badges" class="page-section">
        <div class="glass-card">
            <h5 class="fw-bold mb-3"><i class="fas fa-medal text-warning me-2"></i>‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°</h5>
            <div class="badge-grid" id="badgeContainer"></div>
        </div>
    </div>

    <div id="page-manager" class="page-section">
        <div class="glass-card">
            <h5 class="fw-bold mb-3"><i class="fas fa-chart-line text-primary me-2"></i>Executive Dashboard</h5>
            <div class="row g-2 mb-3">
                <div class="col-6"><div class="stat-card"><div class="stat-num text-warning">88%</div><div class="stat-label">Happy Index</div></div></div>
                <div class="col-6"><div class="stat-card"><div class="stat-num text-info">--</div><div class="stat-label">Issues</div></div></div>
            </div>
            
            <div class="mb-4">
                <small class="fw-bold text-muted">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç (4 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</small>
                <div style="height: 150px;">
                    <canvas id="managerLineChart"></canvas>
                </div>
            </div>

            <div class="mb-4 pt-3 border-top position-relative">
                <h6 class="fw-bold mb-3"><i class="fas fa-layer-group text-success me-2"></i>TRD Core Values</h6>
                <div class="row text-center mb-2" id="trdScoreCards"></div>
                <div style="height: 200px;">
                    <canvas id="trdBarChart"></canvas>
                </div>
                <small class="text-muted d-block mt-2 text-center" style="font-size: 0.7rem;">
                    *T=‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï | R=‡∏ß‡∏¥‡∏ô‡∏±‡∏¢+‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á | D=‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤+‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π
                </small>
            </div>
            
            <h6 class="fw-bold border-bottom pb-2 d-flex justify-content-between">
                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ <small class="text-muted" style="font-size:0.6rem">üî¥‡∏ß‡∏¥‡∏Å‡∏§‡∏ï üü†‡∏£‡∏∞‡∏ß‡∏±‡∏á üü¢‡∏õ‡∏Å‡∏ï‡∏¥</small>
            </h6>
            <div id="staffListArea"></div>
        </div>
    </div>

</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('record', this)"><i class="fas fa-plus-circle"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></div>
    <div class="nav-item" onclick="switchTab('stories', this)"><i class="fas fa-images"></i><span>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß</span></div>
    <div class="nav-item" onclick="switchTab('stats', this)"><i class="fas fa-chart-pie"></i><span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span></div>
    <div class="nav-item" onclick="switchTab('badges', this)"><i class="fas fa-medal"></i><span>‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</span></div>
    <div class="nav-item" onclick="switchTab('manager', this)"><i class="fas fa-user-tie"></i><span>‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</span></div>
</div>

<script>
    // --- ‚ö†Ô∏è CONFIGURATION: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ö†Ô∏è ---
    const LIFF_ID = '2009069961-FRS5kHE4'; 
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxRvEyRoQaxOUWR_6pTslNmCrM7IiZTRYzDDUtPtDmrhGehUq6zQpfm9MKp_CYzVmrX/exec';

    const badgeConfig = {
        'volunteer': { title: '‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤', levels: [{count:1, rank:'‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà', icon:'üå±', desc:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏î‡∏µ'}, {count:5, rank:'‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ', icon:'ü§ù', desc:'‡∏ä‡πà‡∏ß‡∏¢ 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}, {count:20, rank:'‡πÉ‡∏à‡∏ö‡∏∏‡∏ç', icon:'üíñ', desc:'‡∏ä‡πà‡∏ß‡∏¢ 20 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}, {count:50, rank:'‡∏ô‡∏±‡∏Å‡∏ö‡∏∏‡∏ç', icon:'üòá', desc:'‡∏ä‡πà‡∏ß‡∏¢ 50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}, {count:100, rank:'‡πÄ‡∏ó‡∏ß‡∏î‡∏≤', icon:'ü™Ω', desc:'‡∏ä‡πà‡∏ß‡∏¢ 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}] },
        'sufficiency': { title: '‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á', levels: [{count:1, rank:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', icon:'üíß', desc:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á'}, {count:10, rank:'‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î', icon:'üê∑', desc:'‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}, {count:50, rank:'‡∏™‡∏°‡∏ñ‡∏∞', icon:'üßò', desc:'‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á 50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}, {count:100, rank:'‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå', icon:'üåæ', desc:'‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}] },
        'discipline': { title: '‡∏ß‡∏¥‡∏ô‡∏±‡∏¢', levels: [{count:1, rank:'‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô', icon:'üëü', desc:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢'}, {count:10, rank:'‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤', icon:'‚è∞', desc:'‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}, {count:50, rank:'‡πÅ‡∏ö‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á', icon:'‚öñÔ∏è', desc:'‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ 50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}, {count:100, rank:'‡∏à‡∏≠‡∏°‡∏ó‡∏±‡∏û', icon:'üíÇ', desc:'‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}] },
        'integrity': { title: '‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï', levels: [{count:1, rank:'‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à', icon:'ü§ç', desc:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå'}, {count:10, rank:'‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™', icon:'üîç', desc:'‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}, {count:50, rank:'‡∏ï‡∏á‡∏â‡∏¥‡∏ô', icon:'üõ°Ô∏è', desc:'‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï 50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}, {count:100, rank:'‡πÄ‡∏õ‡∏≤‡∏ö‡∏∏‡πâ‡∏ô‡∏à‡∏¥‡πâ‡∏ô', icon:'‚öñÔ∏è', desc:'‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}] },
        'gratitude': { title: '‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π', levels: [{count:1, rank:'‡∏£‡∏∞‡∏•‡∏∂‡∏Å‡∏Ñ‡∏∏‡∏ì', icon:'üí≠', desc:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π'}, {count:10, rank:'‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô', icon:'üéÅ', desc:'‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}, {count:50, rank:'‡∏Å‡∏ï‡πÄ‡∏ß‡∏ó‡∏µ', icon:'üôá', desc:'‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π 50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}, {count:100, rank:'‡∏≠‡∏†‡∏¥‡∏ä‡∏≤‡∏ï‡∏ö‡∏∏‡∏ï‡∏£', icon:'üëë', desc:'‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}] },
        'rich_score': { title: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ', source: 'score', levels: [{count:100, rank:'Newbie', icon:'ü•â', desc:'100 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'}, {count:500, rank:'Rookie', icon:'ü•à', desc:'500 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'}, {count:1000, rank:'Pro', icon:'ü•á', desc:'1,000 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'}, {count:5000, rank:'Elite', icon:'üèÜ', desc:'5,000 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'}] },
        'active_total': { title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏¢‡∏±‡∏ô', source: 'total', levels: [{count:10, rank:'Active', icon:'üèÉ', desc:'10 ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'}, {count:50, rank:'Super', icon:'üöÄ', desc:'50 ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'}, {count:100, rank:'Hyper', icon:'‚ö°', desc:'100 ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'}] }
    };

    let currentUser = null;
    let selectedMood = 3;
    let chartData = []; 
    // --- üåç IMAGE VARS ---
    let currentImageFiles = []; 
    let selectedImageBase64 = null;

    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            await checkUser(profile.userId, profile);
        } catch (err) {
            console.error('LIFF Error:', err);
            activateDemoMode();
        }
    }

    function activateDemoMode() {
        console.warn('Entering Demo Mode');
        document.getElementById('loading').style.display = 'none';
        currentUser = { name: "Demo User", role: "Admin", score: 999, level: 99, dominantVirtue: 'volunteer', img: "https://dummyimage.com/90x90/cccccc/ffffff&text=User", userId: "U_TEST_1234" };
        renderProfile();
    }

    main();

    function checkUser(userId, profile) {
        fetch(GAS_URL, { 
            method: 'POST', 
            headers: { "Content-Type": "text/plain;charset=utf-8" }, 
            body: JSON.stringify({ action: 'check_user', userId: userId }) 
        })
        .then(res => res.json())
        .then(data => {
            if (data.exists) { 
                currentUser = { ...data.user, userId: userId }; 
                renderProfile(); 
                fetchManagerData();
                fetchFriendsList(); 
            } else { 
                registerUser(userId, profile); 
            }
            document.getElementById('loading').style.display = 'none';
        })
        .catch(err => {
            console.error(err);
            Swal.fire({ icon: 'error', title: 'Connection Error', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Deploy (Anyone)', footer: err.message });
            document.getElementById('loading').style.display = 'none';
        });
    }

    function registerUser(userId, profile) {
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'register_user', userId: userId, userName: profile.displayName, userImg: profile.pictureUrl }) })
        .then(() => checkUser(userId, profile));
    }

    function renderProfile() {
        if(!currentUser) return;
        document.getElementById('userName').innerText = currentUser.name;
        document.getElementById('userRole').innerHTML = `${currentUser.role || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'} ‚Ä¢ <span class="text-primary fw-bold">Lv.${currentUser.level || 1}</span>`;
        document.getElementById('userImg').src = currentUser.img || 'https://dummyimage.com/90x90/cccccc/ffffff&text=User';
        
        let happyPercent = (parseFloat(currentUser.happyScore || 0) / 10) * 100;
        document.querySelector('.bar-happy').style.width = `${Math.min(happyPercent, 100)}%`;
        let currentScore = currentUser.score || 0;
        let virtuePercent = ((currentScore % 500) / 500) * 100;
        if (currentScore > 0 && virtuePercent === 0) virtuePercent = 100;
        document.querySelector('.bar-virtue').style.width = `${virtuePercent}%`;

        // --- ‚ú® AURA LOGIC ---
        const auraEl = document.getElementById('userAura');
        if (auraEl) {
             const dominant = (currentUser.dominantVirtue || 'none').toLowerCase();
             const level = parseInt(currentUser.level) || 1;
             auraEl.className = `aura-glow aura-${dominant}`;
             
             let scale = 1 + (level * 0.05);
             if (scale > 2.5) scale = 2.5;
             auraEl.style.setProperty('--scale', scale);

             if (level >= 20) auraEl.classList.add('aura-lv-20');
             else if (level >= 10) auraEl.classList.add('aura-lv-10');
             else if (level >= 5) auraEl.classList.add('aura-lv-5');
             else auraEl.classList.add('aura-lv-1');
        }
        
        // --- Stat Text ---
        const domVirtue = currentUser.dominantVirtue || 'none';
        const statConfig = {
            'volunteer': { title: 'üíñ ‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á', desc: '‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏•‡∏∞', color: '#3498db', bg: '#e8f4fc' },
            'sufficiency': { title: 'üå± ‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á', desc: '‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤', color: '#2ecc71', bg: '#eafaf1' },
            'discipline': { title: '‚ö° ‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏ß‡∏¥‡∏ô‡∏±‡∏¢', desc: '‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏™‡∏π‡∏á', color: '#9b59b6', bg: '#f5eef8' },
            'integrity': { title: 'üõ°Ô∏è ‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', desc: '‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™', color: '#00cec9', bg: '#e0fbfc' },
            'gratitude': { title: 'üôè ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏ô‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π', desc: '‡∏£‡∏π‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏ô ‡∏≠‡πà‡∏≠‡∏ô‡∏ô‡πâ‡∏≠‡∏°', color: '#e84393', bg: '#fcecf5' },
            'none': { title: 'üåü ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', desc: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞', color: '#95a5a6', bg: '#f4f6f6' }
        };
        const cfg = statConfig[domVirtue] || statConfig['none'];
        const statBox = document.getElementById('statAnalysis');
        if (statBox) {
            document.getElementById('statTitle').innerHTML = `<i class="fas fa-quote-left fa-xs me-2 opacity-50"></i>${cfg.title}`;
            document.getElementById('statTitle').style.color = cfg.color;
            document.getElementById('statDesc').innerText = cfg.desc;
            statBox.style.backgroundColor = cfg.bg;
            statBox.style.borderColor = cfg.color;
            statBox.style.borderLeftWidth = '5px';
        }
        if (typeof initUserRadar === 'function') initUserRadar();
        if (typeof renderBadges === 'function') renderBadges();
    }

    function fetchFriendsList() {
        if (!currentUser || !currentUser.userId) return;
        const container = document.getElementById('friendListArea'); 
        if (!container) return;
        container.innerHTML = '<div class="col-12 text-center text-muted small"><div class="spinner-border spinner-border-sm"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô...</div>';

        fetch(`${GAS_URL}?action=get_users`)
        .then(res => res.json())
        .then(data => {
            container.innerHTML = ''; 
            let count = 0;
            data.forEach(user => {
                if (String(user.lineId) === String(currentUser.userId)) return;
                count++;
                const div = document.createElement('div');
                div.className = 'col-6 mb-2';
                div.innerHTML = `
                    <div class="friend-item p-2 border rounded d-flex align-items-center bg-white shadow-sm" data-id="${user.lineId}" onclick="toggleFriend(this)">
                        <img src="${user.img || 'https://dummyimage.com/35x35/cccccc/ffffff&text=Friend'}" class="rounded-circle me-2 border" width="35" height="35" style="object-fit:cover;">
                        <div class="text-truncate small fw-bold" style="max-width: 120px;">${user.name}</div>
                    </div>
                `;
                container.appendChild(div);
            });
            if (count === 0) container.innerHTML = '<div class="col-12 text-center text-muted small py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô</div>';
        })
        .catch(err => container.innerHTML = '<div class="col-12 text-center text-danger small">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>');
    }

    function toggleFriend(el) {
        el.classList.toggle('selected');
        if (el.classList.contains('selected')) {
            el.style.borderColor = '#6c5ce7'; el.style.backgroundColor = '#f0f0ff';
            if(!el.querySelector('.check-mark')) {
                const check = document.createElement('i'); check.className = 'fas fa-check-circle text-primary ms-auto check-mark'; el.appendChild(check);
            }
        } else {
            el.style.borderColor = 'transparent'; el.style.backgroundColor = 'white';
            const check = el.querySelector('.check-mark'); if(check) check.remove();
        }
    }

    function renderBadges() {
        const container = document.getElementById('badgeContainer');
        if(!container || !currentUser) return;
        container.innerHTML = '';
        let storageKey = `happyMeter_badges_${currentUser.userId}`;
        let storedLevels = JSON.parse(localStorage.getItem(storageKey)) || {};

        Object.keys(badgeConfig).forEach(badgeKey => {
            const config = badgeConfig[badgeKey];
            const myStats = currentUser.virtueStats || {};
            let currentCount = (config.source === 'score') ? (currentUser.score||0) : (config.source === 'total' ? (currentUser.totalCount||0) : (myStats[badgeKey]||0));
            
            let realLevelIdx = 0;
            for (let i = config.levels.length - 1; i >= 0; i--) {
                if (currentCount >= config.levels[i].count) { realLevelIdx = i + 1; break; }
            }
            const seenLevelIdx = storedLevels[badgeKey] || 0;

            let html = '';
            if (realLevelIdx === 0) {
                html = `<div class="badge-item badge-locked" onclick="viewBadge('${config.title}','‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ','üîí')"><div class="badge-icon">üîí</div><small>${config.title}</small></div>`;
            } else if (realLevelIdx > seenLevelIdx) {
                const nxt = config.levels[realLevelIdx - 1];
                html = `<div class="badge-item badge-mystery-upgrade" onclick="revealUpgrade('${badgeKey}', ${realLevelIdx}, '${config.title} ${nxt.rank}', '${nxt.icon}')"><div class="badge-icon">üéÅ</div><small>‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î!</small></div>`;
            } else {
                const cur = config.levels[realLevelIdx - 1];
                html = `<div class="badge-item" onclick="viewBadge('${config.title} ${cur.rank}','${cur.desc}','${cur.icon}')"><div class="badge-icon">${cur.icon}</div><small>${config.title} ${cur.rank}</small></div>`;
            }
            container.innerHTML += html;
        });
    }

    function fetchManagerData() {
        if (!currentUser || (currentUser.role !== 'Manager' && currentUser.role !== 'Admin')) return;
        fetch(`${GAS_URL}?action=get_dashboard`).then(res => res.json()).then(data => {
            if(data.users) { renderStaffList(data.users); renderTRDChart(data.users); }
            if(data.trend) { chartData = data.trend; renderManagerChart(); }
        });
    }

    function renderStaffList(users) {
        const sList = document.getElementById('staffListArea');
        if (!sList) return;
        sList.innerHTML = '';
        users.sort((a,b) => ((a.score%10)+1) - ((b.score%10)+1));

        users.forEach(f => {
            let happyScore = (f.score % 10) + 1; 
            let statusClass = happyScore < 5 ? 'status-critical' : (happyScore < 7 ? 'status-warning' : 'status-normal');
            let icon = happyScore < 5 ? 'üî¥' : (happyScore < 7 ? 'üü†' : 'üü¢');
            let rescueHtml = (statusClass === 'status-critical' && f.topFriends && f.topFriends.length > 0) ? 
                `<div class="mt-2 p-2 bg-light border-start border-danger border-3 rounded small"><i class="fas fa-robot me-1"></i>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡πÅ‡∏•: <b>${f.topFriends[0].name}</b></div>` : '';

            const div = document.createElement('div');
            div.className = `p-3 staff-row border-bottom ${statusClass}`;
            div.onclick = () => showStaffDetail(f, happyScore);
            div.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="position-relative">
                        <img src="${f.img}" style="width:50px; height:50px; border-radius:50%; margin-right:15px;">
                        <span class="position-absolute bottom-0 end-0 badge rounded-pill bg-dark border border-white" style="font-size:0.6rem;">Lv.${f.level}</span>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <div><h6 class="fw-bold mb-0">${f.name}</h6><span class="badge bg-light text-dark border">${f.role}</span></div>
                            <div class="text-end fw-bold fs-5">${happyScore} <small>${icon}</small></div>
                        </div>
                        ${rescueHtml}
                    </div>
                </div>`;
            sList.appendChild(div);
        });
    }

    function setMood(val, btn) {
        selectedMood = val; 
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    function addEmoji(emoji) { document.getElementById('noteInput').value += emoji + ' '; }
    function selectAllFriends() {
        const items = document.querySelectorAll('.friend-item');
        const btn = document.getElementById('btnSelectAll');
        const isSelect = btn.innerHTML.includes('All');
        items.forEach(i => isSelect ? i.classList.add('selected') : i.classList.remove('selected'));
        btn.innerHTML = isSelect ? '<i class="fas fa-times me-1"></i>Cancel' : '<i class="fas fa-check-double me-1"></i>All';
        items.forEach(i => toggleFriend(i)); 
    }

    // --- üì∏ IMAGE LOGIC ---
    function handleFileSelect(input) {
        if (!input.files || input.files.length === 0) return;
        const newFiles = Array.from(input.files);
        if (currentImageFiles.length + newFiles.length > 3) {
            Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
            input.value = ''; return;
        }
        currentImageFiles = [...currentImageFiles, ...newFiles];
        refreshGallery();
        input.value = ''; 
    }

    function removeImage(index) {
        currentImageFiles.splice(index, 1);
        refreshGallery();
    }

    async function refreshGallery() {
        const thumbContainer = document.getElementById('thumbList');
        const preview = document.getElementById('previewArea');
        thumbContainer.innerHTML = '';
        
        currentImageFiles.forEach((file, idx) => {
            const url = URL.createObjectURL(file);
            const div = document.createElement('div');
            div.className = 'thumb-item animate__animated animate__fadeInRight';
            div.innerHTML = `<img src="${url}" class="thumb-img"><button class="btn-remove-img" onclick="removeImage(${idx})"><i class="fas fa-times"></i></button>`;
            thumbContainer.appendChild(div);
        });

        if (currentImageFiles.length === 0) {
            selectedImageBase64 = null;
            preview.style.backgroundImage = 'none';
            preview.innerHTML = '<small class="text-muted position-absolute top-50 start-50 translate-middle">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</small>';
            return;
        }

        preview.innerHTML = '<div class="spinner-border text-secondary m-auto"></div>';
        try {
            const imageObjects = await Promise.all(currentImageFiles.map(f => loadImage(f)));
            const mergedBase64 = await mergeImagesToCanvas(imageObjects);
            selectedImageBase64 = mergedBase64;
            preview.innerHTML = '';
            preview.style.backgroundImage = `url(${mergedBase64})`;
        } catch (err) { console.error(err); }
    }

    function loadImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => { const img = new Image(); img.onload = () => resolve(img); img.src = e.target.result; };
            reader.readAsDataURL(file);
        });
    }

    function mergeImagesToCanvas(images) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            const W = 1000; const H = 800; canvas.width = W; canvas.height = H;
            ctx.fillStyle = "#000000"; ctx.fillRect(0, 0, W, H);
            const count = images.length; const gap = 15;

            if (count === 1) drawImageProp(ctx, images[0], 0, 0, W, H);
            else if (count === 2) {
                const halfW = (W - gap) / 2;
                drawImageProp(ctx, images[0], 0, 0, halfW, H);
                drawImageProp(ctx, images[1], halfW + gap, 0, halfW, H);
            } else if (count === 3) {
                const col1W = (W - gap) / 2; const col2W = (W - gap) / 2; const col2X = col1W + gap; const rowH = (H - gap) / 2;
                drawImageProp(ctx, images[0], 0, 0, col1W, H);
                drawImageProp(ctx, images[1], col2X, 0, col2W, rowH);
                drawImageProp(ctx, images[2], col2X, rowH + gap, col2W, rowH);
            }
            resolve(canvas.toDataURL('image/jpeg', 0.8));
        });
    }

    function drawImageProp(ctx, img, x, y, w, h) {
        const offsetX = 0.5, offsetY = 0.5;
        const iw = img.width, ih = img.height, r = Math.min(w / iw, h / ih);
        let nw = iw * r, nh = ih * r, cx, cy, cw, ch, ar = 1;
        if (nw < w) ar = w / nw; if (Math.abs(ar - 1) < 1e-14 && nh < h) ar = h / nh;
        nw *= ar; nh *= ar; cw = iw / (nw / w); ch = ih / (nh / h); cx = (iw - cw) * offsetX; cy = (ih - ch) * offsetY;
        if (cx < 0) cx = 0; if (cy < 0) cy = 0; if (cw > iw) cw = iw; if (ch > ih) ch = ih;
        ctx.drawImage(img, cx, cy, cw, ch, x, y, w, h);
    }

    async function submitData() {
        if(!currentUser) return Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');
        const btn = document.querySelector('button[onclick="submitData()"]');
        const originalText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
        
        try {
            const tagged = Array.from(document.querySelectorAll('.friend-item.selected')).map(el => el.dataset.id).join(',');
            let uploadId = null; let totalChunks = 0;
            
            if (selectedImageBase64) {
                uploadId = Date.now().toString();
                const CHUNK_SIZE = 50000;
                totalChunks = Math.ceil(selectedImageBase64.length / CHUNK_SIZE);
                for (let i = 0; i < totalChunks; i++) {
                    const chunk = selectedImageBase64.substring(i * CHUNK_SIZE, Math.min((i + 1) * CHUNK_SIZE, selectedImageBase64.length));
                    btn.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ${Math.round(((i+1)/totalChunks)*100)}%`;
                    await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'upload_chunk', uploadId: uploadId, chunkIndex: i, chunkData: chunk }) });
                }
            }
            btn.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ 
                action: 'submit_activity', userId: currentUser.userId, userName: currentUser.name, 
                happyLevel: selectedMood, virtueTag: document.getElementById('virtueSelect').value, 
                note: document.getElementById('noteInput').value, taggedFriends: tagged, uploadId: uploadId, totalChunks: totalChunks 
            }) });
            Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', showConfirmButton: false, timer: 2000 }).then(() => { location.reload(); });
        } catch (err) { 
            console.error(err); Swal.fire('Error', err.message, 'error'); btn.disabled = false; btn.innerHTML = originalText;
        }
    }

    function switchTab(pageId, el) {
        if (pageId === 'manager' && (!currentUser || (currentUser.role !== 'Manager' && currentUser.role !== 'Admin'))) {
            Swal.fire({ icon: 'error', title: 'Access Denied', text: '‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô' }); return;
        }
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if (el) el.classList.add('active');
        document.getElementById('header-user').style.display = (pageId === 'manager') ? 'none' : 'block';
        if(pageId === 'manager') fetchManagerData();
        if(pageId === 'stories') fetchFeed();
        if(pageId === 'record' && typeof refreshGallery === 'function') refreshGallery();
    }

    function fetchFeed() {
        const container = document.getElementById('feedContainer'); if (!container) return;
        container.innerHTML = '<div class="text-center py-5 text-muted"><div class="spinner-border spinner-border-sm"></div><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
        fetch(GAS_URL + '?action=get_feed&t=' + new Date().getTime()).then(res => res.json()).then(feed => {
            container.innerHTML = '';
            if (!feed || feed.length === 0) { container.innerHTML = '<div class="text-center py-5 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß</div>'; return; }
            feed.forEach(post => {
                let timeAgo = "-"; try { timeAgo = new Date(post.timestamp).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' }); } catch(e) {}
                let imgUrl = post.image; if(imgUrl && imgUrl.startsWith('http:')) imgUrl = imgUrl.replace('http:', 'https:');
                const imgHtml = (imgUrl && imgUrl.length > 10) ? `<img src="${imgUrl}" class="feed-img" onclick="viewImage('${imgUrl}')">` : '';
                
                let verifyBtnHtml = ''; let verifyList = post.verifies || [];
                let isVerifiedByMe = verifyList.some(v => String(v.lineId) === String(currentUser.userId));
                let isMyPost = String(post.user_line_id) === String(currentUser.userId);
                let isBonus = post.bonusGiven === "TRUE" || verifyList.length >= 4;

                if (isMyPost) {
                    if (post.taggedFriends && post.taggedFriends.length > 0) verifyBtnHtml = `<span class="badge bg-success rounded-pill ms-auto">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡∏° (+10)</span>`;
                    else verifyBtnHtml = isBonus ? `<span class="badge bg-warning text-dark rounded-pill ms-auto">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÅ‡∏ï‡∏Å! (+8)</span>` : `<span class="badge bg-secondary rounded-pill ms-auto">‡∏£‡∏≠‡∏û‡∏¢‡∏≤‡∏ô (${verifyList.length}/4)</span>`;
                } else {
                    verifyBtnHtml = isVerifiedByMe ? `<button class="btn btn-sm btn-success rounded-pill ms-auto disabled">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß (+3)</button>` : `<button onclick="verifyPost('${post.id}', '${post.user_line_id}', '${post.user_name}')" class="btn btn-sm btn-outline-primary rounded-pill ms-auto">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (+3)</button>`;
                }

                let avatarsHtml = '';
                if (verifyList.length > 0) {
                    verifyList.forEach(v => { avatarsHtml += `<img src="${v.img}" class="rounded-circle border border-white ms-1" width="25" height="25">`; });
                    avatarsHtml = `<div class="d-flex align-items-center mt-2 p-2 bg-light rounded small"><span class="text-primary me-2 fw-bold">‡∏û‡∏¢‡∏≤‡∏ô:</span>${avatarsHtml}</div>`;
                }

                let isLiked = post.likes && post.likes.some(u => String(u.lineId) === String(currentUser.userId));
                let likeBtnHtml = `<div class="action-btn ${isLiked ? 'liked' : ''}" onclick="likePost('${post.id}')"><i class="${isLiked ? 'fas' : 'far'} fa-heart me-1"></i> ${post.likes?post.likes.length:0} ‡∏ñ‡∏π‡∏Å‡πÉ‡∏à</div>`;

                const html = `<div class="glass-card feed-card p-3 mb-3">
                    <div class="feed-header d-flex align-items-center">
                        <img src="${post.user_img}" class="feed-avatar me-2">
                        <div class="feed-user"><h6 class="mb-0 fw-bold">${post.user_name}</h6><small class="text-muted">${timeAgo} ‚Ä¢ <span class="badge bg-light text-dark border">${post.virtue}</span></small></div>
                        ${verifyBtnHtml}
                    </div>
                    <div class="feed-content mt-2 mb-2">${post.note || ''}</div>
                    ${imgHtml} ${avatarsHtml}
                    <div class="feed-actions mt-2 pt-2 border-top d-flex align-items-center justify-content-between">${likeBtnHtml}</div>
                </div>`;
                container.innerHTML += html;
            });
        }).catch(err => container.innerHTML = `<div class="alert alert-danger">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`);
    }

    function verifyPost(postId, targetId, targetName) {
        Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ?', text: `‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏≤‡∏ô‡πÉ‡∏´‡πâ ${targetName}?`, icon: 'question', showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (+3)' }).then((res) => {
            if (res.isConfirmed) {
                Swal.showLoading();
                fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'verify_post', postId: postId, verifierId: currentUser.userId, targetUserLineId: targetId }) })
                .then(() => { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¢‡∏≤‡∏ô +3', 'success').then(() => { fetchFeed(); checkUser(currentUser.userId); }); });
            }
        });
    }

    function likePost(postId) {
        const btn = event.currentTarget;
        if (!btn.classList.contains('liked')) {
            btn.classList.add('liked'); btn.innerHTML = `<i class="fas fa-heart me-1"></i> ${parseInt(btn.innerText) + 1} ‡∏ñ‡∏π‡∏Å‡πÉ‡∏à`;
            fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'like_post', postId: postId, userId: currentUser.userId }) });
        }
    }

    function viewImage(url) { Swal.fire({ imageUrl: url, imageWidth: '100%', showConfirmButton: false, showCloseButton: true, background: 'transparent' }); }
    function showVirtueInfo() { Swal.fire({ title: 'üìå ‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ', html: '<div class="text-start fs-6">...‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...</div>', confirmButtonColor: '#6c5ce7' }); }
    function revealUpgrade(badgeKey, newLevelIdx, title, icon) { confetti(); Swal.fire({ title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!', text: `‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç ${title}`, imageUrl: `https://dummyimage.com/200x200/eee/000&text=${icon}`, confirmButtonColor: '#6c5ce7' }); }
    function viewBadge(t,d,i) { Swal.fire({ title: i+' '+t, text: d, confirmButtonColor: '#6c5ce7' }); }

    function renderTRDChart(users) {
        let scoreT=0, scoreR=0, scoreD=0;
        users.forEach(u => { const v=u.virtueStats||{}; scoreT+=(v['integrity']||0); scoreR+=(v['discipline']||0)+(v['sufficiency']||0); scoreD+=(v['volunteer']||0)+(v['gratitude']||0); });
        document.getElementById('trdScoreCards').innerHTML = `<div class="col-4 border-end"><h3 class="text-primary">${scoreT}</h3><small>Transparent</small></div><div class="col-4 border-end"><h3 class="text-warning">${scoreR}</h3><small>Responsible</small></div><div class="col-4"><h3 class="text-danger">${scoreD}</h3><small>Dedicated</small></div>`;
        const ctx = document.getElementById('trdBarChart'); if(window.myTrdChart) window.myTrdChart.destroy();
        window.myTrdChart = new Chart(ctx, { type: 'bar', data: { labels: ['T', 'R', 'D'], datasets: [{ label: 'Score', data: [scoreT, scoreR, scoreD], backgroundColor: ['#3498db', '#f1c40f', '#e74c3c'] }] }, options: { responsive: true, maintainAspectRatio: false } });
    }
    function renderManagerChart() {
        const ctx = document.getElementById('managerLineChart'); if(window.myManagerChart) window.myManagerChart.destroy();
        if(!chartData || chartData.length === 0) return;
        window.myManagerChart = new Chart(ctx, { type: 'line', data: { labels: chartData.map((_, i) => i+1), datasets: [{ label: 'Happy Index', data: chartData, borderColor: '#0984e3', fill: true }] }, options: { scales: { y: { min:0, max:10, display:false }, x: { display:false } }, plugins:{legend:{display:false}} } });
    }
    function showStaffDetail(user, score) { Swal.fire({ html: `<img src="${user.img}" style="width:90px; border-radius:50%; margin-bottom:10px;"><br><h5>${user.name}</h5><span>${user.role}</span><br>Score: ${user.score}` }); }
</script>
</body>
</html>
