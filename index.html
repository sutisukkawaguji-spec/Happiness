<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Meter | Executive Intelligence</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --primary: #6c5ce7;
            --accent: #fd79a8;
        }
        body { background-image: var(--bg-gradient); font-family: 'Kanit', sans-serif; min-height: 100vh; color: #444; padding-bottom: 100px; overflow-x: hidden; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 24px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.6); }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏¢‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏ö */
        .thumb-item {
            position: relative;
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }
        .btn-remove-img {
            position: absolute; top: 2px; right: 2px;
            background: rgba(255, 0, 0, 0.8); color: white;
            border: none; border-radius: 50%; width: 20px; height: 20px;
            font-size: 12px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10;
        }
        .btn-remove-img:hover { background: red; }

        /* --- üñºÔ∏è Interactive Image Editor --- */
        .editor-container {
            width: 100%;
            padding-bottom: 66.66%; /* Aspect Ratio 3:2 (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Canvas 1200x800) */
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            touch-action: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏ì‡∏∞‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ */
        }
        .editor-slot {
            position: absolute;
            overflow: hidden;
            background-color: #333;
            /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏≤‡∏ß‡πÅ‡∏ö‡∏ö‡∏°‡∏ô */
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 15px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏ô‡∏Ç‡∏≠‡∏á‡∏°‡∏∏‡∏° */
        }
        .editor-img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* ‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏≠‡∏ö */
            object-position: 50% 50%; /* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            cursor: move;
            pointer-events: auto;
        }
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô */
        .btn-confirm-img {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white; border: none; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
        }
        
        /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (Container) --- */
        .profile-container { 
            position: relative; 
            display: inline-block; 
            width: 100px; /* üëà ‡∏•‡πá‡∏≠‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏ö */
            height: 100px; /* üëà ‡∏•‡πá‡∏≠‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏£‡∏≠‡∏ö */
            margin-bottom: 15px; 
            z-index: 1;
        }
        
        /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (Image) --- */
        .profile-img { 
            width: 90px !important;  /* üëà ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏ß‡πâ‡∏≤‡∏á 90px */
            height: 90px !important; /* üëà ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á 90px */
            border-radius: 50%; 
            border: 3px solid #fff; 
            position: absolute; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏õ‡πä‡∏∞‡πÜ */
            z-index: 5; /* üëà ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ Aura ‡∏£‡∏π‡∏õ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ö‡πÅ‡∏™‡∏á */
            object-fit: cover; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            background: #fff;
        }
        /* ‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏£‡πà‡∏≤ (‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ scale) */
        .aura-glow { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            /* ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ --scale ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å JS (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ 1) */
            transform: translate(-50%, -50%) scale(var(--scale, 1)); 
            width: 110px; 
            height: 110px; 
            border-radius: 50%; 
            z-index: 1; 
            filter: blur(15px); 
            opacity: 0.8; 
            transition: all 0.5s ease;
        }

        /* üî• EFFECT: ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏Ç‡∏¢‡∏≤‡∏¢‡πÑ‡∏ß‡πâ ‡πÑ‡∏°‡πà‡∏´‡∏î‡∏Å‡∏•‡∏±‡∏ö */
        @keyframes pulse-slow { 
            0% { transform: translate(-50%, -50%) scale(var(--scale, 1)); opacity: 0.7; } 
            50% { transform: translate(-50%, -50%) scale(calc(var(--scale, 1) * 1.1)); opacity: 0.9; } 
            100% { transform: translate(-50%, -50%) scale(var(--scale, 1)); opacity: 0.7; } 
        }

        @keyframes rotate-aura { 
            0% { transform: translate(-50%, -50%) scale(var(--scale, 1)) rotate(0deg); } 
            100% { transform: translate(-50%, -50%) scale(var(--scale, 1)) rotate(360deg); } 
        }

        @keyframes god-mode { 
            0% { filter: blur(15px) hue-rotate(0deg); } 
            100% { filter: blur(25px) hue-rotate(360deg); } 
        }

        /* Class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Level ‡∏ï‡πà‡∏≤‡∏á‡πÜ */
        .aura-lv-1 { animation: pulse-slow 4s infinite; }
        .aura-lv-5 { animation: pulse-slow 2s infinite; filter: blur(18px); }
        .aura-lv-10 { animation: rotate-aura 10s linear infinite; filter: blur(20px); }
        .aura-lv-20 { animation: rotate-aura 5s linear infinite, god-mode 3s infinite alternate; }

        /* ‡∏™‡∏µ‡∏≠‡∏≠‡∏£‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏¢ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
        .aura-volunteer { background: radial-gradient(circle, #3498db 0%, transparent 70%); box-shadow: 0 0 30px rgba(52, 152, 219, 0.8); }
        .aura-sufficiency { background: radial-gradient(circle, #2ecc71 0%, transparent 70%); box-shadow: 0 0 30px rgba(46, 204, 113, 0.8); }
        .aura-discipline { background: radial-gradient(circle, #9b59b6 0%, transparent 70%); box-shadow: 0 0 30px rgba(155, 89, 182, 0.8); }
        .aura-integrity { background: radial-gradient(circle, #00cec9 0%, transparent 70%); box-shadow: 0 0 30px rgba(0, 206, 201, 0.8); }
        .aura-gratitude { background: radial-gradient(circle, #e84393 0%, transparent 70%); box-shadow: 0 0 30px rgba(232, 67, 147, 0.8); }
        .aura-none { background: #dfe6e9; opacity: 0.2; }

        /* Energy Bars */
        .power-bar-label { font-size: 0.75rem; font-weight: 600; color: #666; display: flex; justify-content: space-between; margin-bottom: 2px;}
        .progress { height: 8px; border-radius: 5px; background: #e0e0e0; margin-bottom: 10px; }
        .bar-happy { background: linear-gradient(90deg, #ffeaa7, #fdcb6e); }
        .bar-virtue { background: linear-gradient(90deg, #81ecec, #00cec9); }

        /* Inputs & Friend List */
        .mood- { display: flex; justify-content: space-around; background: #fff; padding: 10px; border-radius: 20px; }
        .mood-btn { border: none; background: none; font-size: 2.2rem; opacity: 0.4; transition: 0.2s; filter: grayscale(1); }
        .mood-btn.active { opacity: 1; transform: scale(1.2); filter: grayscale(0); }
        .friend-list { max-height: 250px; overflow-y: auto; }
        .friend-item { 
            display: flex; 
            align-items: center; 
            padding: 8px 12px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Padding ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢ */
            border-radius: 12px; 
            background: #fff; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
            margin-bottom: 6px; 
            cursor: pointer; /* ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏°‡∏∑‡∏≠ */
            transition: all 0.2s; 
            border: 2px solid transparent; /* ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡∏≠‡∏ö‡πÑ‡∏ß‡πâ */
            user-select: none; /* ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏≤‡∏Å‡∏Ñ‡∏•‡∏∏‡∏°‡∏î‡∏≥‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ */
        }
        .friend-item:hover {
            transform: translateY(-2px);
            background-color: #f8f9fa;
        }
        .friend-item.selected { background: #fff; border-color: var(--primary); box-shadow: 0 2px 8px rgba(108, 92, 231, 0.2); }
        .friend-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover;}

        /* Feed / Stories Styling */
        .feed-card { background: #fff; border-radius: 20px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .feed-header { display: flex; align-items: center; margin-bottom: 10px; }
        .feed-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 2px solid #f0f0f0; }
        .feed-user h6 { margin: 0; font-weight: bold; font-size: 0.95rem; }
        .feed-user small { color: #999; font-size: 0.75rem; }
        .feed-img { width: 100%; border-radius: 12px; margin-bottom: 10px; display: block; object-fit: cover; max-height: 400px; background: #f8f9fa; cursor: pointer; }
        .feed-badge { background: rgba(108, 92, 231, 0.1); color: var(--primary); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
        .feed-content { font-size: 0.9rem; color: #555; line-height: 1.5; }
        .feed-actions { border-top: 1px solid #f0f0f0; margin-top: 10px; padding-top: 10px; display: flex; gap: 15px; }
        .action-btn { color: #aaa; font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
        .action-btn:hover { color: var(--accent); }
        .action-btn.liked { color: #ff7675; }

        /* Radar Chart */
        .radar-wrapper { position: relative; height: 320px; width: 320px; margin: 20px auto; }
        .radar-icon { position: absolute; width: 32px; height: 32px; background: #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1rem; color: #555; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .ri-top { top: 0; left: 50%; transform: translateX(-50%); color: #0984e3; } 
        .ri-tr  { top: 25%; right: 0; color: #6c5ce7; }
        .ri-br  { bottom: 15%; right: 5%; color: #fdcb6e; } 
        .ri-bl  { bottom: 15%; left: 5%; color: #ff7675; } 
        .ri-tl  { top: 25%; left: 0; color: #00b894; } 

        /* Manager Dashboard */
        .stat-card { background: #fff; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-num { font-size: 1.5rem; font-weight: bold; }
        .staff-row { cursor: pointer; transition: 0.2s; border-left: 5px solid transparent; }
        .staff-row:hover { background: #f8f9fa; transform: translateX(5px); }
        .status-critical { border-left-color: #ff7675; background: rgba(255, 118, 117, 0.05); }
        .status-warning { border-left-color: #ffeaa7; background: rgba(255, 234, 167, 0.1); }
        .status-normal { border-left-color: #55efc4; }
        .helper-avatar { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; margin-right: -10px; }

        /* Others */
        .img-preview-container { width: 100%; height: 200px; background-color: #f0f2f5; border-radius: 12px; margin-top: 10px; display: none; background-size: cover; background-position: center; border: 2px dashed #ccc; }
        .badge-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .badge-item { background: #fff; border-radius: 15px; padding: 15px 5px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .badge-item:hover { transform: translateY(-3px); }
        .badge-icon { font-size: 2rem; margin-bottom: 5px; }
        .info-btn { color: #aaa; cursor: pointer; margin-left: 5px; transition: 0.2s; }
        .info-btn:hover { color: var(--primary); }
        
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 450px; background: #fff; border-radius: 50px; padding: 10px; display: flex; justify-content: space-between; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 999; }
        .nav-item { text-align: center; flex: 1; color: #ccc; cursor: pointer; font-size: 1.2rem; transition: 0.3s; padding: 5px; border-radius: 20px; }
        .nav-item.active { color: var(--primary); background: rgba(108, 92, 231, 0.1); }
        .nav-item span { display: block; font-size: 0.6rem; margin-top: 2px; }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .page-section { display: none; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .badge-mystery-upgrade {
            background: linear-gradient(135deg, #a8e063, #56ab2f);
            color: white;
            animation: shakeBox 2s infinite;
            border: 2px solid #fff;
        }
        @keyframes shakeBox {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</p>
</div>

<div class="container mt-3">

    <div id="header-user" class="glass-card text-center pb-2">
        <div class="row align-items-center">
            <div class="col-4">
                <div class="profile-container">
                    <div id="userAura" class="aura-glow aura-active"></div>
                    <img id="userImg" src="https://dummyimage.com/90x90/cccccc/ffffff&text=User" class="profile-img">
                </div>
            </div>
            <div class="col-8 text-start">
                <h4 id="userName" class="fw-bold mb-1">...</h4>
                <small id="userRole" class="text-muted d-block mb-2">...</small>
                <div class="power-bar-label"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç</span><i class="fas fa-bolt text-warning"></i></div>
                <div class="progress"><div class="progress-bar bar-happy" style="width: 80%"></div></div>
                <div class="power-bar-label"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</span><i class="fas fa-star text-info"></i></div>
                <div class="progress"><div class="progress-bar bar-virtue" style="width: 50%"></div></div>
            </div>
        </div>
    </div>

    <div id="page-record" class="page-section active">
        <div class="glass-card">
            <label class="form-label fw-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
            <div class="mood-container mb-3">
                <button class="mood-btn" onclick="setMood(1, this)">üòû</button>
                <button class="mood-btn" onclick="setMood(2, this)">üòê</button>
                <button class="mood-btn active" onclick="setMood(3, this)">üòÅ</button>
            </div>
            
            <label class="form-label fw-bold d-flex align-items-center">‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ <i class="fas fa-circle-question info-btn fa-lg" onclick="showVirtueInfo()"></i></label>
            <select class="form-select mb-3" id="virtueSelect" style="border-radius: 12px; height: 50px; font-weight: bold;">
                <option value="" disabled selected>‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ ‚Äî</option>
                <option value="volunteer" style="color:#00a8ff;">ü§ù ‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤ (Volunteer)</option>
                <option value="sufficiency" style="color:#44bd32;">üå± ‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á (Sufficiency)</option>
                <option value="discipline" style="color:#8c7ae6;">üìè ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ (Discipline)</option>
                <option value="integrity" style="color:#00cec9;">üíé ‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï (Integrity)</option>
                <option value="gratitude" style="color:#e84393;">üôè ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π (Gratitude)</option>
            </select>

            <div class="mb-3">
                <textarea class="form-control mb-2" rows="2" placeholder="‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤..." id="noteInput" style="border-radius: 12px;"></textarea>
                <div class="d-flex gap-2 overflow-auto pb-2">
                    <span class="badge bg-white text-dark border p-2" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                    <span class="badge bg-white text-dark border p-2" onclick="addEmoji('‚úåÔ∏è')">‚úåÔ∏è</span>
                    <span class="badge bg-white text-dark border p-2" onclick="addEmoji('üî•')">üî•</span>
                    <span class="badge bg-white text-dark border p-2" onclick="addEmoji('üôè')">üôè</span>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-outline-secondary w-100 rounded-3 mt-2" onclick="document.getElementById('fileCam').click()">
                        <i class="fas fa-camera me-2"></i>‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ)
                    </button>
                    <input type="file" id="fileCam" hidden accept="image/*" multiple onchange="handleFileSelect(this)">
                
                    <div id="thumbList" class="d-flex gap-2 mt-2 overflow-auto" style="white-space: nowrap;"></div>
                
                    <div id="editorWrapper" class="mt-3" style="display:none;">
                        <small class="text-primary mb-1 d-block"><i class="fas fa-hand-pointer"></i> ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</small>
                        <div id="collageEditor" class="editor-container"></div>
                        <button class="btn btn-confirm-img w-100 mt-2 py-2 rounded-pill" onclick="finalizeImage()">
                            <i class="fas fa-check-circle me-1"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ
                        </button>
                    </div>

                    <input type="hidden" id="finalBase64">
                </div>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label fw-bold mb-0">‡∏ó‡∏≥‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£?</label>
                <button class="btn btn-sm btn-outline-primary rounded-pill px-3" id="btnSelectAll" onclick="selectAllFriends()"><i class="fas fa-check-double me-1"></i>All</button>
            </div>
            <div class="friend-list row" id="friendListArea"></div> <button class="btn btn-primary w-100 py-3 rounded-4 shadow mt-3 fw-bold" onclick="submitData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</button>
        </div>
    </div>

    <div id="page-stories" class="page-section">
        <h5 class="fw-bold mb-3 px-2">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
        <div id="feedContainer" style="min-height: 200px;">
            <div class="text-center py-5 text-muted">
                <div class="spinner-border spinner-border-sm mb-2"></div><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß...
            </div>
        </div>
    </div>

<div id="page-stats" class="page-section">
        <div class="glass-card text-center">
            <h5 class="fw-bold">‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏û‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h5>
            <div class="radar-wrapper">
                <div class="radar-icon ri-top"><i class="fas fa-ruler-combined"></i></div>
                <div class="radar-icon ri-tr"><i class="fas fa-gem"></i></div>
                <div class="radar-icon ri-br"><i class="fas fa-hands-praying"></i></div>
                <div class="radar-icon ri-bl"><i class="fas fa-hand-holding-heart"></i></div>
                <div class="radar-icon ri-tl"><i class="fas fa-leaf"></i></div>
                <canvas id="userRadarChart"></canvas>
            </div>

            <div id="statAnalysis" class="mt-2 p-3 rounded-4 border shadow-sm" style="transition: all 0.5s ease;">
                <h5 id="statTitle" class="fw-bold mb-2">...</h5>
                <p id="statDesc" class="small text-dark mb-0" style="opacity: 0.8;">...</p>
            </div>

        </div>
    </div>

    <div id="page-badges" class="page-section">
        <div class="glass-card">
            <h5 class="fw-bold mb-3"><i class="fas fa-medal text-warning me-2"></i>‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°</h5>
            <div class="badge-grid" id="badgeContainer"></div>
        </div>
    </div>

    <div id="page-manager" class="page-section">
        <div class="glass-card">
            <h5 class="fw-bold mb-3"><i class="fas fa-chart-line text-primary me-2"></i>Executive Dashboard</h5>
            <div class="row g-2 mb-3">
                <div class="col-6"><div class="stat-card"><div class="stat-num text-warning">88%</div><div class="stat-label">Happy Index</div></div></div>
                <div class="col-6"><div class="stat-card"><div class="stat-num text-info">--</div><div class="stat-label">Issues</div></div></div>
            </div>
            <div class="mb-4 position-relative">
                <small class="fw-bold text-muted">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç (4 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</small>
                <canvas id="managerLineChart" height="150"></canvas>
                <div class="mb-4 position-relative">
                </div>

            <div class="mb-4 pt-3 border-top">
                <h6 class="fw-bold mb-3"><i class="fas fa-layer-group text-success me-2"></i>TRD Core Values Analysis</h6>
                <div class="row text-center mb-2" id="trdScoreCards">
                    </div>
                <div style="height: 200px;">
                    <canvas id="trdBarChart"></canvas>
                </div>
                <small class="text-muted d-block mt-2 text-center" style="font-size: 0.7rem;">
                    *T=‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï | R=‡∏ß‡∏¥‡∏ô‡∏±‡∏¢+‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á | D=‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤+‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π
                </small>
            </div>
            
            <h6 class="fw-bold border-bottom pb-2 ...">...</h6>
                <div id="trendAlert" class="badge bg-danger position-absolute top-0 end-0 mt-4" style="display:none;"><i class="fas fa-arrow-down"></i> ‡∏Ç‡∏≤‡∏•‡∏á</div>
            </div>
            <h6 class="fw-bold border-bottom pb-2 d-flex justify-content-between">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ <small class="text-muted" style="font-size:0.6rem">üî¥‡∏ß‡∏¥‡∏Å‡∏§‡∏ï üü†‡∏£‡∏∞‡∏ß‡∏±‡∏á üü¢‡∏õ‡∏Å‡∏ï‡∏¥</small></h6>
            <div id="staffListArea"></div>
        </div>
    </div>

</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('record', this)"><i class="fas fa-plus-circle"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></div>
    <div class="nav-item" onclick="switchTab('stories', this)"><i class="fas fa-images"></i><span>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß</span></div>
    <div class="nav-item" onclick="switchTab('stats', this)"><i class="fas fa-chart-pie"></i><span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span></div>
    <div class="nav-item" onclick="switchTab('badges', this)"><i class="fas fa-medal"></i><span>‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</span></div>
    <div class="nav-item" onclick="switchTab('manager', this)"><i class="fas fa-user-tie"></i><span>‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</span></div>
</div>

<script>
    // --- ‚ö†Ô∏è CONFIGURATION: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ö†Ô∏è ---
    const LIFF_ID = '2009069961-FRS5kHE4'; // ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxRvEyRoQaxOUWR_6pTslNmCrM7IiZTRYzDDUtPtDmrhGehUq6zQpfm9MKp_CYzVmrX/exec'; // ‡πÉ‡∏™‡πà URL ‡∏à‡∏≤‡∏Å Apps Script

    // --- üèÜ BADGE CONFIGURATION: ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏ï‡πá‡∏° ---
    const badgeConfig = {
        // ü§ù ‡∏™‡∏≤‡∏¢‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤
        'volunteer': {
            title: '‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤',
            levels: [
                { count: 1,  rank: '‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà', icon: 'üå±', desc: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏≥‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å' },
                { count: 5,  rank: '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ',   icon: 'ü§ù', desc: '‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
                { count: 20, rank: '‡πÉ‡∏à‡∏ö‡∏∏‡∏ç',  icon: 'üíñ', desc: '‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏∏‡∏ç‡∏Ñ‡∏£‡∏ö 20 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
                { count: 50, rank: '‡∏ô‡∏±‡∏Å‡∏ö‡∏∏‡∏ç', icon: 'üòá', desc: '‡∏≠‡∏∏‡∏ó‡∏¥‡∏®‡∏ï‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Ñ‡∏° (50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)' },
                { count: 100, rank: '‡πÄ‡∏ó‡∏ß‡∏î‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏î‡∏¥‡∏ô', icon: 'ü™Ω', desc: '‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏•‡∏∞ (100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)' }
            ]
        },
        // üå± ‡∏™‡∏≤‡∏¢‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á
        'sufficiency': {
            title: '‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á',
            levels: [
                { count: 1,  rank: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', icon: 'üíß', desc: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ñ‡∏µ‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á' },
                { count: 10, rank: '‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î', icon: 'üê∑', desc: '‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏≠‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô' },
                { count: 50, rank: '‡∏™‡∏°‡∏ñ‡∏∞',   icon: 'üßò', desc: '‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢ (50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)' },
                { count: 100, rank: '‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå', icon: 'üåæ', desc: '‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ß‡∏¥‡∏ñ‡∏µ‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á' }
            ]
        },
        // üìè ‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ô‡∏±‡∏¢
        'discipline': {
            title: '‡∏ß‡∏¥‡∏ô‡∏±‡∏¢',
            levels: [
                { count: 1,  rank: '‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô',   icon: 'üëü', desc: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ß‡∏¥‡∏ô‡∏±‡∏¢' },
                { count: 10, rank: '‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤', icon: '‚è∞', desc: '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
                { count: 50, rank: '‡πÅ‡∏ö‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á', icon: '‚öñÔ∏è', desc: '‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ (50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)' },
                { count: 100, rank: '‡∏à‡∏≠‡∏°‡∏ó‡∏±‡∏û',  icon: 'üíÇ', desc: '‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏î‡∏∏‡∏à‡∏ó‡∏´‡∏≤‡∏£‡∏Å‡∏•‡πâ‡∏≤' }
            ]
        },
        // üíé ‡∏™‡∏≤‡∏¢‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå
        'integrity': {
            title: '‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï',
            levels: [
                { count: 1,  rank: '‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à',   icon: 'ü§ç', desc: '‡∏û‡∏π‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á' },
                { count: 10, rank: '‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™',  icon: 'üîç', desc: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠ (10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)' },
                { count: 50, rank: '‡∏ï‡∏á‡∏â‡∏¥‡∏ô',    icon: 'üõ°Ô∏è', desc: '‡∏¢‡∏∂‡∏î‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)' },
                { count: 100, rank: '‡πÄ‡∏õ‡∏≤‡∏ö‡∏∏‡πâ‡∏ô‡∏à‡∏¥‡πâ‡∏ô', icon: '‚öñÔ∏è', desc: '‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∏‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏°' }
            ]
        },
        // üôè ‡∏™‡∏≤‡∏¢‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π
        'gratitude': {
            title: '‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π',
            levels: [
                { count: 1,  rank: '‡∏£‡∏∞‡∏•‡∏∂‡∏Å‡∏Ñ‡∏∏‡∏ì', icon: 'üí≠', desc: '‡πÑ‡∏°‡πà‡∏•‡∏∑‡∏°‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì' },
                { count: 10, rank: '‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô',  icon: 'üéÅ', desc: '‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏ô 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
                { count: 50, rank: '‡∏Å‡∏ï‡πÄ‡∏ß‡∏ó‡∏µ',   icon: 'üôá', desc: '‡∏ú‡∏π‡πâ‡∏£‡∏π‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á' },
                { count: 100, rank: '‡∏≠‡∏†‡∏¥‡∏ä‡∏≤‡∏ï‡∏ö‡∏∏‡∏ï‡∏£', icon: 'üëë', desc: '‡∏¢‡∏≠‡∏î‡∏Ñ‡∏ô‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π' }
            ]
        },
        // üí∞ ‡∏™‡∏≤‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (Rich Score)
        'rich_score': {
            title: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ',
            source: 'score', 
            levels: [
                { count: 100,   rank: 'Newbie',    icon: 'ü•â', desc: '‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏£‡∏ö 100 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' },
                { count: 500,   rank: 'Rookie',    icon: 'ü•à', desc: '‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏£‡∏ö 500 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' },
                { count: 1000,  rank: 'Pro',       icon: 'ü•á', desc: '‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏£‡∏ö 1,000 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' },
                { count: 5000,  rank: 'Elite',     icon: 'üèÜ', desc: '‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏£‡∏ö 5,000 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' },
                { count: 10000, rank: 'Legend',    icon: 'üëë', desc: '‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô (10,000 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)' },
                { count: 50000, rank: 'Immortal',  icon: 'ü¶Ñ', desc: '‡∏≠‡∏°‡∏ï‡∏∞ (50,000 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)' }
            ]
        },
        // üî• ‡∏™‡∏≤‡∏¢‡∏Ç‡∏¢‡∏±‡∏ô (Total Activities)
        'active_total': {
            title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏¢‡∏±‡∏ô',
            source: 'total', 
            levels: [
                { count: 10,  rank: 'Active',      icon: 'üèÉ', desc: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏£‡∏ö 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
                { count: 50,  rank: 'Super',       icon: 'üöÄ', desc: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏£‡∏ö 50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
                { count: 100, rank: 'Hyper',       icon: '‚ö°', desc: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏£‡∏ö 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
                { count: 365, rank: 'Daily Hero',  icon: 'üìÖ', desc: '‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á 365 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á!' }
            ]
        }
    };

    currentUser = null;
     selectedMood = 3;
     chartData = []; 
    // --- üåç IMAGE VARS ---
    let currentImageFiles = []; 
    let selectedImageBase64 = null;

    // --- MAIN FUNCTION ---
    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { 
                liff.login(); 
                return; 
            }
            const profile = await liff.getProfile();
            await checkUser(profile.userId, profile);
        } catch (err) {
            console.error('LIFF Error:', err);
            activateDemoMode();
        }
    }

    // --- DEMO MODE ---
    function activateDemoMode() {
        console.warn('Entering Demo Mode');
        document.getElementById('loading').style.display = 'none';
        currentUser = { name: "Test User (PC)", role: "Admin", score: 999, level: 99, badges: ['badge_volunteer', 'badge_time'], img: "https://dummyimage.com/90x90/cccccc/ffffff&text=User", userId: "U_TEST_1234" };
        renderProfile();
        switchTab('record', document.querySelector('.nav-item.active'));
    }

    main();

    // 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
    function handleFileSelect(input) {
        if (!input.files || input.files.length === 0) return;
        const newFiles = Array.from(input.files);
        
        if (currentImageFiles.length + newFiles.length > 3) {
            Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
            input.value = ''; return;
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Offset ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á (0.5, 0.5)
        currentImageFiles = [...currentImageFiles, ...newFiles];
        newFiles.forEach(() => imageOffsets.push({ x: 0.5, y: 0.5 }));
        
        renderEditor(); // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á
        input.value = ''; 
    }

    // 2. ‡∏•‡∏ö‡∏£‡∏π‡∏õ
    function removeImage(index) {
        currentImageFiles.splice(index, 1);
        imageOffsets.splice(index, 1);
        renderEditor();
    }

    // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Editor (HTML Layout)
    async function renderEditor() {
        const wrapper = document.getElementById('editorWrapper');
        const editor = document.getElementById('collageEditor');
        const thumbList = document.getElementById('thumbList');
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Thumbnails
        thumbList.innerHTML = '';
        currentImageFiles.forEach((file, idx) => {
            const url = URL.createObjectURL(file);
            thumbList.innerHTML += `<div class="thumb-item"><img src="${url}" class="thumb-img"><button class="btn-remove-img" onclick="removeImage(${idx})">√ó</button></div>`;
        });

        if (currentImageFiles.length === 0) {
            wrapper.style.display = 'none';
            return;
        }

        wrapper.style.display = 'block';
        editor.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô URL
        const imageUrls = currentImageFiles.map(f => URL.createObjectURL(f));
        const count = imageUrls.length;
        const gap = 1.5; // ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á % (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤ 15px ‡πÉ‡∏ô 1200px)

        // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á Layout ‡∏î‡πâ‡∏ß‡∏¢ HTML/CSS (‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö Canvas) ---
        // ‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % : (Value / 1200) * 100
        
        imageUrls.forEach((url, idx) => {
            const div = document.createElement('div');
            div.className = 'editor-slot';
            const img = document.createElement('img');
            img.className = 'editor-img';
            img.src = url;
            
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
            img.style.objectPosition = `${imageOffsets[idx].x * 100}% ${imageOffsets[idx].y * 100}%`;
            
            // ‡πÉ‡∏™‡πà Event ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ
            enableDrag(img, idx);

            // --- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Absolute Layout) ---
            if (count === 1) {
                setStyles(div, 0, 0, 100, 100);
            } 
            else if (count === 2) {
                if(idx === 0) setStyles(div, 0, 0, 49.2, 100); // ‡∏ã‡πâ‡∏≤‡∏¢
                else          setStyles(div, 50.8, 0, 49.2, 100); // ‡∏Ç‡∏ß‡∏≤
            } 
            else if (count === 3) {
                if(idx === 0) setStyles(div, 0, 0, 49.2, 50);      // ‡∏ö‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
                else if(idx === 1) setStyles(div, 50.8, 0, 49.2, 50); // ‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤
                else          setStyles(div, 0, 51.5, 100, 48.5);  // ‡∏•‡πà‡∏≤‡∏á‡∏¢‡∏≤‡∏ß
            }

            div.appendChild(img);
            editor.appendChild(div);
        });
    }

    // Helper ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CSS Layout
    function setStyles(el, l, t, w, h) {
        el.style.left = l + '%';
        el.style.top = t + '%';
        el.style.width = w + '%';
        el.style.height = h + '%';
    }

    // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å (Drag Logic)
    function enableDrag(imgElement, index) {
        let startX, startY, startPosX, startPosY;
        
        const onStart = (e) => {
            // e.preventDefault(); // (Optional) ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ô Scroll ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startX = clientX;
            startY = clientY;
            
            // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ object-position ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 0.0 - 1.0)
            const currentPos = imgElement.style.objectPosition.split(' ');
            startPosX = parseFloat(currentPos[0]) / 100;
            startPosY = parseFloat(currentPos[1]) / 100;
            
            document.addEventListener('mousemove', onMove);
            document.addEventListener('touchmove', onMove, { passive: false });
            document.addEventListener('mouseup', onEnd);
            document.addEventListener('touchend', onEnd);
        };

        const onMove = (e) => {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô (Sensitivity)
            const sensitive = 0.002; 
            
            let newX = startPosX - (clientX - startX) * sensitive;
            let newY = startPosY - (clientY - startY) * sensitive;

            // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï 0 - 100%
            newX = Math.max(0, Math.min(1, newX));
            newY = Math.max(0, Math.min(1, newY));

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            imgElement.style.objectPosition = `${newX * 100}% ${newY * 100}%`;
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô Gen ‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á
            imageOffsets[index] = { x: newX, y: newY };
        };

        const onEnd = () => {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('mouseup', onEnd);
            document.removeEventListener('touchend', onEnd);
        };

        imgElement.addEventListener('mousedown', onStart);
        imgElement.addEventListener('touchstart', onStart);
    }

    // --- üì∏ IMAGE SYSTEM (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: Layout 3 ‡∏£‡∏π‡∏õ + ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß) ---
    
    // 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
    function handleFileSelect(input) {
        if (!input.files || input.files.length === 0) return;
        const newFiles = Array.from(input.files);
        
        if (currentImageFiles.length + newFiles.length > 3) {
            Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
            input.value = ''; return;
        }
        
        currentImageFiles = [...currentImageFiles, ...newFiles];
        refreshGallery();
        input.value = ''; 
    }

    // 2. ‡∏•‡∏ö‡∏£‡∏π‡∏õ
    function removeImage(index) {
        currentImageFiles.splice(index, 1);
        refreshGallery();
    }

    // 3. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà
    async function refreshGallery() {
        const thumbContainer = document.getElementById('thumbList');
        const preview = document.getElementById('previewArea');
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Thumbnails
        thumbContainer.innerHTML = '';
        currentImageFiles.forEach((file, idx) => {
            const url = URL.createObjectURL(file);
            const div = document.createElement('div');
            div.className = 'thumb-item animate__animated animate__fadeInRight';
            div.innerHTML = `<img src="${url}" class="thumb-img"><button class="btn-remove-img" onclick="removeImage(${idx})"><i class="fas fa-times"></i></button>`;
            thumbContainer.appendChild(div);
        });

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
        if (currentImageFiles.length === 0) {
            selectedImageBase64 = null;
            preview.style.backgroundImage = 'none';
            preview.innerHTML = '<small class="text-muted position-absolute top-50 start-50 translate-middle">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</small>';
            return;
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏û
        preview.innerHTML = '<div class="spinner-border text-secondary m-auto"></div>';
        try {
            const imageObjects = await Promise.all(currentImageFiles.map(f => loadImage(f)));
            const mergedBase64 = await mergeImagesToCanvas(imageObjects);
            
            selectedImageBase64 = mergedBase64;
            preview.innerHTML = '';
            preview.style.backgroundImage = `url(${mergedBase64})`;
        } catch (err) { console.error(err); }
    }

    // 4. Helper: ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ
    function loadImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => { const img = new Image(); img.onload = () => resolve(img); img.src = e.target.result; };
            reader.readAsDataURL(file);
        });
    }

    // 5. Helper: ‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏û‡πÉ‡∏ô Canvas (Layout ‡πÉ‡∏´‡∏°‡πà + ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô + ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß)
    function mergeImagesToCanvas(images) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const W = 1200; const H = 800;
            canvas.width = W; canvas.height = H;

            // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≥ (‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏±‡πâ‡∏ô)
            ctx.fillStyle = "#000000"; ctx.fillRect(0, 0, W, H);

            const count = images.length;
            const gap = 15;
            const radius = 25;
            const borderW = 4; // ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏≤‡∏ß

            function drawRounded(img, x, y, w, h) {
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x + radius, y); ctx.lineTo(x + w - radius, y);
                ctx.quadraticCurveTo(x + w, y, x + w, y + radius); ctx.lineTo(x + w, y + h - radius);
                ctx.quadraticCurveTo(x + w, y + h, x + w - radius, y + h); ctx.lineTo(x + radius, y + h);
                ctx.quadraticCurveTo(x, y + h, x, y + h - radius); ctx.lineTo(x, y + radius);
                ctx.quadraticCurveTo(x, y, x + radius, y); ctx.closePath();

                // ‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ
                ctx.save(); 
                ctx.clip();
                drawImageProp(ctx, img, x, y, w, h);
                ctx.restore();

                // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
                ctx.strokeStyle = "#FFFFFF"; 
                ctx.lineWidth = borderW; 
                ctx.stroke();
                
                ctx.restore();
            }

            // ‡∏à‡∏±‡∏î Layout
            if (count === 1) { 
                drawRounded(images[0], 0, 0, W, H); 
            } 
            else if (count === 2) {
                const halfW = (W - gap) / 2;
                drawRounded(images[0], 0, 0, halfW, H); 
                drawRounded(images[1], halfW + gap, 0, halfW, H);
            } 
            else if (count === 3) {
                // Layout 3 ‡∏£‡∏π‡∏õ: ‡∏ö‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ / ‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤ / ‡∏•‡πà‡∏≤‡∏á‡∏¢‡∏≤‡∏ß‡πÄ‡∏ï‡πá‡∏°
                const colW = (W - gap) / 2; 
                const rowH = (H - gap) / 2;
                drawRounded(images[0], 0, 0, colW, rowH);
                drawRounded(images[1], colW + gap, 0, colW, rowH);
                drawRounded(images[2], 0, rowH + gap, W, rowH);
            }

            resolve(canvas.toDataURL('image/jpeg', 0.85));
        });
    }

    // 6. Helper: Crop ‡∏†‡∏≤‡∏û
    function drawImageProp(ctx, img, x, y, w, h) {
        const offsetX = 0.5, offsetY = 0.5;
        const iw = img.width, ih = img.height;
        const r = Math.min(w / iw, h / ih);
        let nw = iw * r, nh = ih * r, cx, cy, cw, ch, ar = 1;

        if (nw < w) ar = w / nw;
        if (Math.abs(ar - 1) < 1e-14 && nh < h) ar = h / nh;
        nw *= ar; nh *= ar;

        cw = iw / (nw / w); ch = ih / (nh / h);
        cx = (iw - cw) * offsetX; cy = (ih - ch) * offsetY;

        if (cx < 0) cx = 0; if (cy < 0) cy = 0;
        if (cw > iw) cw = iw; if (ch > ih) ch = ih;

        ctx.drawImage(img, cx, cy, cw, ch, x, y, w, h);
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô checkUser ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
    function checkUser(userId, profile) {
        console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏£‡∏∞‡∏ö‡∏ö..."); // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô Console
        
        // ‡πÉ‡∏ä‡πâ fetch ‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏∏ Header ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô Browser ‡∏ö‡∏•‡πá‡∏≠‡∏Å
        fetch(GAS_URL, { 
            method: 'POST', 
            headers: { "Content-Type": "text/plain;charset=utf-8" }, // üëà ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å! ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô CORS
            body: JSON.stringify({ action: 'check_user', userId: userId }) 
        })
        .then(res => {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Error
            if (!res.ok) throw new Error("HTTP error " + res.status);
            return res.json();
        })
        .then(data => {
            console.log("‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß:", data); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÑ‡∏´‡∏°
            if (data.exists) { 
                currentUser = { ...data.user, userId: userId }; 
                renderProfile(); 
                fetchManagerData();
                fetchFriendsList(); 
            } else { 
                registerUser(userId, profile); 
            }
            document.getElementById('loading').style.display = 'none';
        })
        .catch(err => {
            console.error('Connection Failed:', err);
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
            Swal.fire({
                icon: 'error',
                title: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Deploy (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Anyone)',
                footer: err.message
            });
            document.getElementById('loading').style.display = 'none';
        });
    }

    function registerUser(userId, profile) {
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'register_user', userId: userId, userName: profile.displayName, userImg: profile.pictureUrl }) })
        .then(() => checkUser(userId, profile));
    }

    function renderProfile() {
        if(!currentUser) return;

        document.getElementById('userName').innerText = currentUser.name;
        document.getElementById('userRole').innerHTML = `${currentUser.role || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'} ‚Ä¢ <span class="text-primary fw-bold">Lv.${currentUser.level || 1}</span>`;
        document.getElementById('userImg').src = currentUser.img || 'https://dummyimage.com/90x90/cccccc/ffffff&text=User';
        
        // --- ‡∏´‡∏•‡∏≠‡∏î‡∏û‡∏•‡∏±‡∏á (Bars) ---
        let happyPercent = (parseFloat(currentUser.happyScore || 0) / 10) * 100;
        document.querySelector('.bar-happy').style.width = `${Math.min(happyPercent, 100)}%`;

        let currentScore = currentUser.score || 0;
        let virtuePercent = ((currentScore % 500) / 500) * 100;
        if (currentScore > 0 && virtuePercent === 0) virtuePercent = 100;
        document.querySelector('.bar-virtue').style.width = `${virtuePercent}%`;

        // --- ‚ú® AURA LOGIC (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå) ---
        const auraEl = document.getElementById('userAura');
        if (auraEl) {
             // 1. ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å (Lower Case) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö CSS
             const dominant = (currentUser.dominantVirtue || 'none').toLowerCase();
             const level = parseInt(currentUser.level) || 1;

             // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏Å‡πà‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà
             auraEl.className = `aura-glow aura-${dominant}`;

             // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î (Scale)
             // ‡∏™‡∏π‡∏ï‡∏£: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 1.0, ‡πÄ‡∏û‡∏¥‡πà‡∏° 0.05 ‡∏ó‡∏∏‡∏Å‡πÄ‡∏•‡πÄ‡∏ß‡∏•, ‡∏ï‡∏±‡∏ô‡∏ó‡∏µ‡πà 2.5 ‡πÄ‡∏ó‡πà‡∏≤
             let scale = 1 + (level * 0.05);
             if (scale > 2.5) scale = 2.5;

             // üü¢ ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡πâ CSS ‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Animation ‡∏ó‡∏±‡∏ö)
             auraEl.style.setProperty('--scale', scale);

             // 4. ‡πÉ‡∏™‡πà Effect ‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏•
             if (level >= 20) auraEl.classList.add('aura-lv-20');
             else if (level >= 10) auraEl.classList.add('aura-lv-10');
             else if (level >= 5) auraEl.classList.add('aura-lv-5');
             else auraEl.classList.add('aura-lv-1');
        }
        // -------------------------------------------------------
        // üß† STAT ANALYSIS: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡πÉ‡∏ï‡πâ‡∏Å‡∏£‡∏≤‡∏ü
        // -------------------------------------------------------
        const domVirtue = currentUser.dominantVirtue || 'none';
        const statConfig = {
            'volunteer': { 
                title: 'üíñ ‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á', 
                desc: '‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏•‡∏∞ ‡∏ä‡∏≠‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô', 
                color: '#3498db', 
                bg: '#e8f4fc' 
            },
            'sufficiency': { 
                title: 'üå± ‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á', 
                desc: '‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏î‡∏∏‡∏• ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏≠‡∏î‡∏µ ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤', 
                color: '#2ecc71', 
                bg: '#eafaf1' 
            },
            'discipline': { 
                title: '‚ö° ‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏ß‡∏¥‡∏ô‡∏±‡∏¢', 
                desc: '‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏™‡∏π‡∏á ‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏µ‡πÉ‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£', 
                color: '#9b59b6', 
                bg: '#f5eef8' 
            },
            'integrity': { 
                title: 'üõ°Ô∏è ‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 
                desc: '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∂‡∏î‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ ‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡∏ß‡∏≤‡∏á‡πÉ‡∏à‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î', 
                color: '#00cec9', 
                bg: '#e0fbfc' 
            },
            'gratitude': { 
                title: 'üôè ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏ô‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π', 
                desc: '‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì ‡∏≠‡πà‡∏≠‡∏ô‡∏ô‡πâ‡∏≠‡∏°‡∏ñ‡πà‡∏≠‡∏°‡∏ï‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô', 
                color: '#e84393', 
                bg: '#fcecf5' 
            },
            'none': { 
                title: 'üåü ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', 
                desc: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡πÉ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞!', 
                color: '#95a5a6', 
                bg: '#f4f6f6' 
            }
        };
    
        const cfg = statConfig[domVirtue] || statConfig['none'];
        const statBox = document.getElementById('statAnalysis');
        
        if (statBox) {
            document.getElementById('statTitle').innerHTML = `<i class="fas fa-quote-left fa-xs me-2 opacity-50"></i>${cfg.title}`;
            document.getElementById('statTitle').style.color = cfg.color;
            document.getElementById('statDesc').innerText = cfg.desc;
            
            statBox.style.backgroundColor = cfg.bg;
            statBox.style.borderColor = cfg.color;
            statBox.style.borderLeftWidth = '5px'; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡∏≤‡πÜ
        }
        if (typeof initUserRadar === 'function') initUserRadar();
        if (typeof renderBadges === 'function') renderBadges();
    }

        // -------------------------------------------------------
        // ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°
        // -------------------------------------------------------
        let currentHappyScore = parseFloat(currentUser.happyScore) || 0; 
        if (currentHappyScore === 0) currentHappyScore = 10;

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Radar Chart ‡πÅ‡∏•‡∏∞ Badges
        if (typeof initUserRadar === 'function') initUserRadar();
        if (typeof renderBadges === 'function') renderBadges();

        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏π‡πâ‡∏ä‡∏µ‡∏û (Auto Rescue Logic)
        if (currentHappyScore < 5) {
             console.log("‚ö†Ô∏è Red Zone Detected!");
             fetch(GAS_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ 
                    action: 'trigger_auto_rescue', 
                    userId: currentUser.userId 
                }) 
            });
        }

    // --- CORE FEATURES: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ---
    function fetchFriendsList() {
        if (!currentUser || !currentUser.userId) {
             console.warn("‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô...");
             return;
        }
        
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ID ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö HTML
        const container = document.getElementById('friendListArea'); 
        if (!container) return;
        
        container.innerHTML = '<div class="col-12 text-center text-muted small"><div class="spinner-border spinner-border-sm"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô...</div>';

        fetch(`${GAS_URL}?action=get_users`)
        .then(res => res.json())
        .then(data => {
            container.innerHTML = ''; 
            
            let count = 0;
            data.forEach(user => {
                // üö® ‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å
                if (String(user.lineId) === String(currentUser.userId)) return;

                count++;
                const div = document.createElement('div');
                div.className = 'col-6 mb-2';
                div.innerHTML = `
                    <div class="friend-item p-2 border rounded d-flex align-items-center bg-white shadow-sm" style="cursor:pointer; transition: all 0.2s;" data-id="${user.lineId}" onclick="toggleFriend(this)">
                        <img src="${user.img || 'https://dummyimage.com/35x35/cccccc/ffffff&text=Friend'}" class="rounded-circle me-2 border" width="35" height="35" style="object-fit:cover;">
                        <div class="text-truncate small fw-bold" style="max-width: 120px;">${user.name}</div>
                    </div>
                `;
                container.appendChild(div);
            });

            if (count === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted small py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>';
            }
        })
        .catch(err => {
            console.error('Error fetching friends:', err);
            container.innerHTML = '<div class="col-12 text-center text-danger small">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≤‡∏î‡πÑ‡∏õ)
    function toggleFriend(el) {
        // 1. ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Class (‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏°‡∏µ)
        el.classList.toggle('selected');
        
        // 2. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡πÜ ‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
        if (el.classList.contains('selected')) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á + ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≠‡∏ô
            el.style.borderColor = '#6c5ce7';
            el.style.backgroundColor = '#f0f0ff';
            el.style.boxShadow = '0 2px 8px rgba(108, 92, 231, 0.2)';
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏∑‡πà‡∏≠ (Optional)
            if(!el.querySelector('.check-mark')) {
                const check = document.createElement('i');
                check.className = 'fas fa-check-circle text-primary ms-auto check-mark';
                el.appendChild(check);
            }
        } else {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å: ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
            el.style.borderColor = 'transparent';
            el.style.backgroundColor = 'white';
            el.style.boxShadow = 'none';
            
            // ‡πÄ‡∏≠‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å‡∏≠‡∏≠‡∏Å
            const check = el.querySelector('.check-mark');
            if(check) check.remove();
        }
        console.log("Friend toggled"); // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô Console ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏´‡∏°
    }

    // --- HELPER: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Level Badge ---
    function getCalculatedLevel(badgeKey, userStats, userScore, userTotal) {
        const config = badgeConfig[badgeKey];
        if (!config) return 0;

        let currentCount = 0;
        if (config.source === 'score') {
            currentCount = userScore || 0;
        } else if (config.source === 'total') {
            currentCount = userTotal || 0;
        } else {
            currentCount = userStats[badgeKey] || 0;
        }

        let calculatedLevel = 0;
        for (let i = config.levels.length - 1; i >= 0; i--) {
            if (currentCount >= config.levels[i].count) {
                calculatedLevel = i + 1; 
                break;
            }
        }
        return calculatedLevel;
    }

    // --- üéÅ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç ---
    function renderBadges() {
        const container = document.getElementById('badgeContainer');
        if(!container || !currentUser) return;
        container.innerHTML = '';
        
        const myVirtueStats = currentUser.virtueStats || {};
        const myTotalScore = currentUser.score || 0;
        const myTotalCount = currentUser.totalCount || 0;

        let storageKey = `happyMeter_badges_${currentUser.userId}`;
        let storedLevels = JSON.parse(localStorage.getItem(storageKey)) || {};

        Object.keys(badgeConfig).forEach(badgeKey => {
            const config = badgeConfig[badgeKey];
            const realLevelIdx = getCalculatedLevel(badgeKey, myVirtueStats, myTotalScore, myTotalCount);
            const seenLevelIdx = storedLevels[badgeKey] || 0;

            let html = '';
            if (realLevelIdx === 0) {
                html = `
                    <div class="badge-item badge-locked" onclick="viewBadge('${config.title}', '‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏±‡πâ‡∏ô‡πÅ‡∏£‡∏Å', 'üîí')">
                        <div class="badge-icon">üîí</div>
                        <small>${config.title}</small>
                    </div>`;
            } else if (realLevelIdx > seenLevelIdx) {
                const nextLvConfig = config.levels[realLevelIdx - 1];
                html = `
                    <div class="badge-item badge-mystery-upgrade" onclick="revealUpgrade('${badgeKey}', ${realLevelIdx}, '${config.title} ${nextLvConfig.rank}', '${nextLvConfig.icon}')">
                        <div class="badge-icon">üéÅ</div>
                        <small>‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î!</small>
                    </div>`;
            } else {
                const currentLvConfig = config.levels[realLevelIdx - 1];
                html = `
                    <div class="badge-item" onclick="viewBadge('${config.title} ${currentLvConfig.rank}', '${currentLvConfig.desc}', '${currentLvConfig.icon}')">
                        <div class="badge-icon">${currentLvConfig.icon}</div>
                        <small>${config.title} ${currentLvConfig.rank}</small>
                    </div>`;
            }
            container.innerHTML += html;
        });
    }

    // --- MANAGER FEATURES ---
    function fetchManagerData() {
        if (!currentUser || (currentUser.role !== 'Manager' && currentUser.role !== 'Admin')) return;
        
        fetch(`${GAS_URL}?action=get_dashboard`)
        .then(res => res.json())
        .then(data => {
            if(data.users) {
                renderStaffList(data.users);
                renderTRDChart(data.users); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü TRD
            }
            if(data.trend) {
                 chartData = data.trend;
                 renderManagerChart();
                 checkTrendAndSuggest();
            }
        });
    }

    // --- MANAGER FEATURES: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç ---
    function renderStaffList(users) {
        const sList = document.getElementById('staffListArea');
        if (!sList) return;
        sList.innerHTML = '';

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Red Zone) ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        users.sort((a,b) => {
            let happyA = (a.score % 10) + 1;
            let happyB = (b.score % 10) + 1;
            return happyA - happyB;
        });

        users.forEach(f => {
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç (1-10)
            let happyScore = (f.score % 10) + 1; 
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            let statusClass = 'status-normal';
            let icon = 'üü¢';
            
            if(happyScore < 5) { 
                statusClass = 'status-critical'; 
                icon = 'üî¥'; 
            } else if(happyScore < 7) { 
                statusClass = 'status-warning'; 
                icon = 'üü†'; 
            }
            
            // üö® ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç (Red Zone Rescue Logic)
            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Red Zone (‡∏™‡∏µ‡πÅ‡∏î‡∏á) AND ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡πÑ‡∏î‡πâ
            let rescueActionHtml = '';
            
            if (statusClass === 'status-critical' && f.topFriends && f.topFriends.length > 0) {
                rescueActionHtml = `
                    <div class="mt-2 p-3 bg-white border border-danger rounded shadow-sm d-flex align-items-start fade-in" style="border-left: 5px solid #ff7675 !important;">
                        <div class="me-3" style="font-size: 1.5rem;">ü§ñ</div>
                        <div>
                            <div class="text-danger fw-bold" style="font-size: 0.9rem;">üö® System Action Required</div>
                            <div class="text-dark small mt-1">
                                ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏†‡∏≤‡∏ß‡∏∞‡∏´‡∏°‡∏î‡πÑ‡∏ü ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πà:
                            </div>
                            <div class="mt-2 p-2 bg-light rounded border d-flex align-items-center">
                                <i class="fas fa-user-friends text-primary me-2"></i>
                                <span class="fw-bold text-primary">${f.topFriends[0].name}</span>
                                <span class="text-muted ms-2 small">(‡∏™‡∏ô‡∏¥‡∏ó‡∏Å‡∏±‡∏ô ${f.topFriends[0].count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Element ‡πÅ‡∏ñ‡∏ß‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            const div = document.createElement('div');
            div.className = `p-3 staff-row border-bottom ${statusClass}`;
            
            // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó (‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥)
            let closenessHtml = '';
            if (f.topFriends && f.topFriends.length > 0) {
                closenessHtml = `<div class="mt-1 small text-muted"><i class="fas fa-link me-1"></i>‡∏™‡∏ô‡∏¥‡∏ó‡∏Å‡∏±‡∏ö: ${f.topFriends[0].name}</div>`;
            }

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            div.onclick = () => showStaffDetail(f, happyScore);
            
            // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡πà‡∏≤‡∏á HTML
            div.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <div class="position-relative">
                        <img src="${f.img}" style="width:55px; height:55px; border-radius:50%; margin-right:15px; border: 3px solid #fff; box-shadow: 0 3px 6px rgba(0,0,0,0.1);">
                        <span class="position-absolute bottom-0 end-0 badge rounded-pill bg-dark border border-white" style="font-size:0.6rem; right:10px;">Lv.${f.level}</span>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold text-dark mb-0" style="font-size:1.1rem;">${f.name}</h6>
                                <span class="badge bg-light text-dark border mt-1">${f.role}</span>
                            </div>
                            <div class="text-end">
                                 <div class="fw-bold display-6" style="font-size:1.4rem; line-height:1;">${happyScore}</div>
                                 <small>${icon}</small>
                            </div>
                        </div>
                        ${closenessHtml}
                    </div>
                </div>
                
                ${rescueActionHtml}
            `;
            sList.appendChild(div);
        });
    }

    // --- FORM & SUBMIT ---
    function setMood(val, btn) {
        selectedMood = val; 
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    function addEmoji(emoji) { document.getElementById('noteInput').value += emoji + ' '; }
    

    function selectAllFriends() {
        const items = document.querySelectorAll('.friend-item');
        const btn = document.getElementById('btnSelectAll');
        const isSelect = btn.innerHTML.includes('All');
        items.forEach(i => isSelect ? i.classList.add('selected') : i.classList.remove('selected'));
        btn.innerHTML = isSelect ? '<i class="fas fa-times me-1"></i>Cancel' : '<i class="fas fa-check-double me-1"></i>All';
        btn.classList.toggle('btn-outline-primary'); btn.classList.toggle('btn-outline-danger');
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï CSS ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        items.forEach(i => toggleFriend(i)); 
    }

    async function submitData() {
        if(!currentUser) return Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');

        // ‚ú® ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        const virtueTag = document.getElementById('virtueSelect').value;
        if (!virtueTag) {
            return Swal.fire({
                icon: 'warning',
                title: '‡∏•‡∏∑‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡∏£‡∏±‡∏ö!',
                confirmButtonColor: '#6c5ce7'
            });
        }

        const btn = document.querySelector('button[onclick="submitData()"]');
        const originalText = btn.innerHTML;
        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
        
        try {
            const tagged = Array.from(document.querySelectorAll('.friend-item.selected')).map(el => el.dataset.id).join(',');
            let uploadId = null; let totalChunks = 0;
            
            if (selectedImageBase64) {
                uploadId = Date.now().toString();
                const CHUNK_SIZE = 50000;
                totalChunks = Math.ceil(selectedImageBase64.length / CHUNK_SIZE);
                for (let i = 0; i < totalChunks; i++) {
                    const chunk = selectedImageBase64.substring(i * CHUNK_SIZE, Math.min((i + 1) * CHUNK_SIZE, selectedImageBase64.length));
                    btn.innerHTML = `‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ${Math.round(((i+1)/totalChunks)*100)}%`;
                    await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'upload_chunk', uploadId: uploadId, chunkIndex: i, chunkData: chunk }) });
                }
            }

            btn.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            
            await fetch(GAS_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ 
                    action: 'submit_activity', 
                    userId: currentUser.userId, 
                    userName: currentUser.name, 
                    happyLevel: selectedMood, 
                    virtueTag: virtueTag, 
                    note: document.getElementById('noteInput').value, 
                    taggedFriends: tagged, 
                    uploadId: uploadId, 
                    totalChunks: totalChunks 
                }) 
            });
            
            Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', showConfirmButton: false, timer: 2000 }).then(() => { location.reload(); });

        } catch (err) { 
            console.error(err); 
            Swal.fire('Error', err.message, 'error'); 
            btn.disabled = false; 
            btn.innerHTML = originalText;
        }
    }

    // --- NAVIGATION ---
    function switchTab(pageId, el) {
        if (pageId === 'manager') {
            if (!currentUser || (currentUser.role !== 'Manager' && currentUser.role !== 'Admin')) {
                Swal.fire({ icon: 'error', title: 'Access Denied', text: '‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', confirmButtonColor: '#6c5ce7' });
                return;
            }
        }
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('header-user').style.display = (pageId === 'manager') ? 'none' : 'block';
        if(pageId === 'manager') fetchManagerData();
        if(pageId === 'stories') fetchFeed();
    }

    // --- UTILS & FEED ---
    function initUserRadar() {
        const ctx = document.getElementById('userRadarChart');
        if (!ctx) return;

        // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏ã‡πâ‡∏≠‡∏ô)
        if (window.myRadarChart) {
            window.myRadarChart.destroy();
        }

        window.myRadarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                // üè∑Ô∏è 5 ‡πÅ‡∏â‡∏Å (‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ)
                labels: [
                    'ü§ù ‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤', 
                    'üå± ‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á', 
                    'üìè ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢', 
                    'üíé ‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï', 
                    'üôè ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π'
                ],
                datasets: [{
                    label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ',
                    data: [
                        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏° value ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô <select> (‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å)
                        currentUser.virtueStats['volunteer'] || 0,   // ‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤
                        currentUser.virtueStats['sufficiency'] || 0, // ‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á
                        currentUser.virtueStats['discipline'] || 0,  // ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢
                        currentUser.virtueStats['integrity'] || 0,   // ‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï
                        currentUser.virtueStats['gratitude'] || 0    // ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π
                    ],
                    backgroundColor: 'rgba(255, 193, 7, 0.2)', // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏≠‡∏á (‡∏î‡∏π‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°)
                    borderColor: 'rgba(255, 193, 7, 1)',       // ‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(255, 140, 0, 1)', // ‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏ó‡∏≠‡∏á
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointRadius: 4 // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏∏‡∏î (‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡πÜ)
                }]
            },
            options: {
                layout: {
                    // üîß ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏Å‡∏£‡∏≤‡∏ü ‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏Å‡∏Ç‡∏≠‡∏ö/‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô
                    padding: {
                        top: 20,
                        bottom: 20,
                        left: 20,
                        right: 20
                    }
                },
                scales: {
                    r: {
                        angleLines: { 
                            display: true,
                            color: 'rgba(0,0,0,0.1)' 
                        },
                        grid: { 
                            circular: true, // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏° (‡∏™‡∏ß‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°)
                            color: 'rgba(0,0,0,0.05)' 
                        },
                        suggestedMin: 0,
                        suggestedMax: 10,  // ‡∏™‡πÄ‡∏Å‡∏•‡πÄ‡∏ï‡πá‡∏° 10
                        ticks: { 
                            display: false, // ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡πÄ‡∏Å‡∏• (‡∏£‡∏Å)
                            stepSize: 2 
                        }, 
                        pointLabels: {
                            // üî† ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≤‡∏¢‡πÅ‡∏â‡∏Å
                            font: { 
                                size: 12, 
                                family: "'Kanit', sans-serif",
                                weight: 'bold'
                            },
                            color: '#444', // ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
                            padding: 10   // ‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î
                        }
                    }
                },
                plugins: {
                    legend: { display: false }, // ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Dataset ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return ' ‡∏™‡∏∞‡∏™‡∏°: ' + context.raw + ' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                            }
                        }
                    }
                }
            }
        });
    }
    function renderManagerChart() {
        const ctx = document.getElementById('managerLineChart');
        if(window.myManagerChart) window.myManagerChart.destroy();
        
        // chartData ‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å data.trend ‡πÉ‡∏ô fetchManagerData
        if(!chartData || chartData.length === 0) return;
    
        window.myManagerChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.map((_, i) => i + 1), // ‡πÅ‡∏Å‡∏ô X ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö
                datasets: [{
                    label: '‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£',
                    data: chartData, // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
                    borderColor: '#0984e3',
                    backgroundColor: 'rgba(9, 132, 227, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 2
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: { y: { min: 0, max: 10, display: false }, x: { display: false } }
            }
        });
    }
    function checkTrendAndSuggest() {
       // Logic ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ç‡∏≤‡∏•‡∏á
    }

    function showStaffDetail(user, score) {
        let helperHtml = (score < 7) ? `<div class="mt-3 bg-light p-2 rounded text-start"><small class="text-danger">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡πÅ‡∏•</small></div>` : `<div class="mt-3 bg-light p-2 rounded text-start"><small class="text-success">‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡πÅ‡∏•‡πÅ‡∏•‡πâ‡∏ß</small></div>`;
        Swal.fire({ html: `<img src="${user.img}" style="width:90px; height:90px; border-radius:50%; margin-bottom:10px;"><br><h5 class="fw-bold">${user.name}</h5><span class="badge bg-secondary mb-3">${user.role}</span><div class="row g-2 text-center"><div class="col-6"><div class="border rounded p-2"><h6>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç</h6><span class="${score<5?'text-danger':''}">${score}/10</span></div></div><div class="col-6"><div class="border rounded p-2"><h6>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°</h6><span>${user.score}</span></div></div></div>${helperHtml}`, showConfirmButton: false, showCloseButton: true });
    }

    function fetchFeed() {
        const container = document.getElementById('feedContainer');
        if (!container) return;
        container.innerHTML = '<div class="text-center py-5 text-muted"><div class="spinner-border spinner-border-sm mb-2"></div><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
        
        // ‡πÉ‡∏™‡πà timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏Ñ‡∏ä
        fetch(GAS_URL + '?action=get_feed&t=' + new Date().getTime())
        .then(res => res.json())
        .then(feed => {
            container.innerHTML = '';
            if (!feed || feed.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted"><i class="far fa-newspaper fa-3x mb-3"></i><br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß</div>';
                return;
            }
            
            feed.forEach(post => {
                // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤ ---
                let timeAgo = "-";
                try { timeAgo = new Date(post.timestamp).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' }); } catch(e) {}
                
                // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ---
                let imgUrl = post.image;
                if(imgUrl && imgUrl.startsWith('http:')) imgUrl = imgUrl.replace('http:', 'https:');
                const imgHtml = (imgUrl && imgUrl.length > 10) ? `<img src="${imgUrl}" class="feed-img" onclick="viewImage('${imgUrl}')">` : '';
                
                // --- Emoji ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ---
                const moodEmoji = post.happy == 3 ? 'üòÅ' : (post.happy == 2 ? 'üòê' : 'üòû');

                // --- üõ°Ô∏è LOGIC ‡∏õ‡∏∏‡πà‡∏° VERIFY (‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà) ---
                let verifyBtnHtml = '';
                let verifyList = post.verifies || [];
                let verifyCount = verifyList.length;
                let isVerifiedByMe = verifyList.some(v => String(v.lineId) === String(currentUser.userId));
                let isMyPost = String(post.user_line_id) === String(currentUser.userId);
                let isBonus = post.bonusGiven === "TRUE" || verifyCount >= 4; // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á

                // 1. ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå
                if (isMyPost) {
                    if (post.taggedFriends && post.taggedFriends.length > 0) {
                        // ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏µ‡∏° (Team)
                        verifyBtnHtml = `<span class="badge bg-success rounded-pill ms-auto"><i class="fas fa-users"></i> ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡∏° (+10)</span>`;
                    } else {
                        // ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß (Solo)
                        if (isBonus) {
                             verifyBtnHtml = `<span class="badge bg-warning text-dark rounded-pill ms-auto animate__animated animate__pulse animate__infinite"><i class="fas fa-crown"></i> ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÅ‡∏ï‡∏Å! (+8)</span>`;
                        } else {
                             verifyBtnHtml = `<span class="badge bg-secondary rounded-pill ms-auto"><i class="fas fa-hourglass-half"></i> ‡∏£‡∏≠‡∏û‡∏¢‡∏≤‡∏ô (${verifyCount}/4)</span>`;
                        }
                    }
                } 
                // 2. ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (‡∏Ñ‡∏ô‡∏Å‡∏î)
                else {
                    if (isVerifiedByMe) {
                        verifyBtnHtml = `<button class="btn btn-sm btn-success rounded-pill ms-auto disabled" style="opacity:0.8"><i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß (+3)</button>`;
                    } else {
                        // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏° , this ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                        verifyBtnHtml = `
                            <button onclick="verifyPost('${p.id}', '${p.user_line_id}', '${p.user_name}', this)" class="btn btn-sm btn-outline-primary rounded-pill ms-auto">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (+3)</button>
                                    class="btn btn-sm btn-outline-primary rounded-pill ms-auto shadow-sm">
                                <i class="fas fa-shield-alt"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (+3)
                            </button>
                        `;
                    }
                }
                // --- ‡πÅ‡∏™‡∏î‡∏á Avatar ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ---
                let avatarsHtml = '';
                if (verifyList.length > 0) {
                    verifyList.forEach(v => {
                        avatarsHtml += `<img src="${v.img}" class="rounded-circle border border-white ms-1" width="25" height="25" title="${v.name}" style="object-fit:cover;">`;
                    });
                    avatarsHtml = `<div class="d-flex align-items-center mt-2 p-2 bg-light rounded small"><span class="text-primary me-2 fw-bold"><i class="fas fa-user-check"></i> ‡∏û‡∏¢‡∏≤‡∏ô:</span>${avatarsHtml}</div>`;
                }

                // --- ‚ù§Ô∏è ‡∏õ‡∏∏‡πà‡∏° Like ---
                let isLiked = post.likes && post.likes.some(u => String(u.lineId) === String(currentUser.userId));
                let likeCount = post.likes ? post.likes.length : 0;
                let likeBtnHtml = `
                    <div class="action-btn ${isLiked ? 'liked' : ''}" onclick="likePost('${post.id}')">
                         <i class="${isLiked ? 'fas' : 'far'} fa-heart me-1"></i> ${likeCount} ‡∏ñ‡∏π‡∏Å‡πÉ‡∏à
                    </div>
                `;

                // --- ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö HTML ---
                const html = `
                    <div class="glass-card feed-card p-3 mb-3">
                        <div class="feed-header d-flex align-items-center">
                            <img src="${post.user_img || 'https://dummyimage.com/45x45/cccccc/ffffff&text=User'}" class="feed-avatar me-2">
                            <div class="feed-user">
                                <h6 class="mb-0 fw-bold">${post.user_name}</h6>
                                <small class="text-muted">${timeAgo} ‚Ä¢ <span class="feed-badge badge bg-light text-dark border">${post.virtue}</span></small>
                            </div>
                            ${verifyBtnHtml}
                        </div>
                        
                        <div class="feed-content mt-2 mb-2">${post.note || ''}</div>
                        ${imgHtml}
                        ${avatarsHtml}
                        
                        <div class="feed-actions mt-2 pt-2 border-top d-flex align-items-center justify-content-between">
                            ${likeBtnHtml}
                            <div class="fs-4">${moodEmoji}</div>
                        </div>
                    </div>`;
                
                container.innerHTML += html;
            });
        })
        .catch(err => container.innerHTML = `<div class="alert alert-danger">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</div>`);
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Like (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
    function likePost(postId) {
        // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (UI Feedback)
        const btn = event.currentTarget;
        if (!btn.classList.contains('liked')) {
            btn.classList.add('liked');
            btn.innerHTML = `<i class="fas fa-heart me-1"></i> ${parseInt(btn.innerText) + 1} ‡∏ñ‡∏π‡∏Å‡πÉ‡∏à`;
            
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
            fetch(GAS_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ action: 'like_post', postId: postId, userId: currentUser.userId })
            });
        }
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Verify (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î)
    function verifyPost(postId, targetId, targetName, btnElement) {
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ?',
            text: `‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏≤‡∏ô‡πÉ‡∏´‡πâ ${targetName}?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (+3)',
            confirmButtonColor: '#6c5ce7'
        }).then((res) => {
            if (res.isConfirmed) {
                Swal.showLoading();
                fetch(GAS_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify({ 
                        action: 'verify_post', 
                        postId: postId, 
                        verifierId: currentUser.userId, 
                        targetUserLineId: targetId 
                    }) 
                }).then(() => {
                    // ‚ú® ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    if (btnElement) {
                        btnElement.innerHTML = '<i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                        btnElement.className = 'btn btn-sm btn-success rounded-pill ms-auto disabled';
                        btnElement.removeAttribute('onclick');
                    }
                    Swal.fire({ icon:'success', title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text:'‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¢‡∏≤‡∏ô +3', timer:1500, showConfirmButton:false });
                    // checkUser(currentUser.userId); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ
                });
            }
        });
    }
    
    function viewImage(url) { Swal.fire({ imageUrl: url, imageWidth: '100%', showConfirmButton: false, showCloseButton: true, background: 'transparent' }); }
    function showVirtueInfo() {
        Swal.fire({
            title: 'üìå ‡∏Ñ‡∏≥‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',
            html: `
                <div class="text-start fs-6" style="line-height: 1.6;">
                    <div class="mb-2">
                        <b class="text-success"><i class="fas fa-leaf me-1"></i> ‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á (Sufficiency):</b><br>
                        <small class="text-muted">‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ‡∏°‡∏µ‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô</small><br>
                        ‚úÖ Green Office, ‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏±‡∏Å‡∏™‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß, ‡∏•‡∏î‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤, ‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ä‡πâ
                    </div>
                    <div class="mb-2">
                        <b class="text-primary"><i class="fas fa-user-clock me-1"></i> ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ (Discipline):</b><br>
                        <small class="text-muted">‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤ ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</small><br>
                        ‚úÖ ‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤, ‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö, Big Cleaning Day, ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
                    </div>
                    <div class="mb-2">
                        <b style="color:#00cec9"><i class="fas fa-shield-alt me-1"></i> ‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï (Integrity):</b><br>
                        <small class="text-muted">‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ ‡∏¢‡∏∂‡∏î‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</small><br>
                        ‚úÖ No Gift Policy (‡∏á‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç), ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏¥‡∏ô‡∏ö‡∏ô, ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ
                    </div>
                    <div class="mb-2">
                        <b class="text-danger"><i class="fas fa-hands-helping me-1"></i> ‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤ (Volunteer):</b><br>
                        <small class="text-muted">‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏•‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏ß‡∏° ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡∏∑‡πâ‡∏≠‡∏Å‡∏π‡∏•</small><br>
                        ‚úÖ ‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ‡πÇ‡∏•‡∏´‡∏¥‡∏ï, ‡∏õ‡∏•‡∏π‡∏Å‡∏õ‡πà‡∏≤, ‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á, ‡∏ä‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô
                    </div>
                    <div>
                        <b class="text-warning"><i class="fas fa-praying-hands me-1"></i> ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π (Gratitude):</b><br>
                        <small class="text-muted">‡∏™‡∏≥‡∏ô‡∏∂‡∏Å‡∏£‡∏π‡πâ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô</small><br>
                        ‚úÖ ‡∏ó‡∏≥‡∏ö‡∏∏‡∏ç‡∏ï‡∏±‡∏Å‡∏ö‡∏≤‡∏ï‡∏£, ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏î‡∏≥‡∏´‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà, ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£, ‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£
                    </div>
                </div>
            `,
            confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß',
            confirmButtonColor: '#6c5ce7',
            width: '90%' // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
        });
    }
    function revealUpgrade(badgeKey, newLevelIdx, title, icon) {
        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        Swal.fire({ title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç "${title}"`, imageUrl: `https://dummyimage.com/200x200/eee/000&text=${icon}`, imageWidth: 100, imageHeight: 100, confirmButtonColor: '#6c5ce7', confirmButtonText: '‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î!' }).then(() => {
            let storageKey = `happyMeter_badges_${currentUser.userId}`;
            let storedLevels = JSON.parse(localStorage.getItem(storageKey)) || {};
            storedLevels[badgeKey] = newLevelIdx;
            localStorage.setItem(storageKey, JSON.stringify(storedLevels));
            renderBadges();
        });
    }
    function viewBadge(t,d,i) { Swal.fire({ title: i + ' ' + t, text: d, confirmButtonColor: '#6c5ce7' }); }

    function renderTRDChart(users) {
        // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° TRD ‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
        let scoreT = 0, scoreR = 0, scoreD = 0;
        
        users.forEach(u => {
            const v = u.virtueStats || {};
            // T: Transparent = ‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï
            scoreT += (v['integrity'] || 0);
            // R: Responsible = ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ + ‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á
            scoreR += (v['discipline'] || 0) + (v['sufficiency'] || 0);
            // D: Dedicated = ‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤ + ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π
            scoreD += (v['volunteer'] || 0) + (v['gratitude'] || 0);
        });

        // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        const total = scoreT + scoreR + scoreD || 1; // ‡∏Å‡∏±‡∏ô‡∏´‡∏≤‡∏£ 0
        document.getElementById('trdScoreCards').innerHTML = `
            <div class="col-4 border-end">
                <h3 class="fw-bold text-primary mb-0">${scoreT}</h3>
                <small class="text-muted fw-bold">Transparent</small>
            </div>
            <div class="col-4 border-end">
                <h3 class="fw-bold text-warning mb-0">${scoreR}</h3>
                <small class="text-muted fw-bold">Responsible</small>
            </div>
            <div class="col-4">
                <h3 class="fw-bold text-danger mb-0">${scoreD}</h3>
                <small class="text-muted fw-bold">Dedicated</small>
            </div>
        `;

        // 3. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (Bar Chart)
        const ctx = document.getElementById('trdBarChart');
        if(window.myTrdChart) window.myTrdChart.destroy();

        window.myTrdChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Transparent (T)', 'Responsible (R)', 'Dedicated (D)'],
                datasets: [{
                    label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°',
                    data: [scoreT, scoreR, scoreD],
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',  // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ (T)
                        'rgba(241, 196, 15, 0.7)',  // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (R)
                        'rgba(231, 76, 60, 0.7)'    // ‡∏™‡∏µ‡πÅ‡∏î‡∏á (D)
                    ],
                    borderColor: [
                        'rgba(52, 152, 219, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(231, 76, 60, 1)'
                    ],
                    borderWidth: 1,
                    borderRadius: 5,
                    barThickness: 40
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

</script>
</body>
</html>







