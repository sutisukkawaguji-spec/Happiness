<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Meter | Executive Intelligence</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --primary: #6c5ce7;
            --accent: #fd79a8;
        }
        body { background-image: var(--bg-gradient); font-family: 'Kanit', sans-serif; min-height: 100vh; color: #444; padding-bottom: 100px; overflow-x: hidden; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 24px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.6); }

        /* Profile & Aura */
        .profile-container { position: relative; display: inline-block; margin-bottom: 15px; }
        .profile-img { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #fff; position: relative; z-index: 2; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .aura-glow { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; border-radius: 50%; z-index: 1; filter: blur(15px); opacity: 0.7; transition: 0.5s; }
        .aura-normal { background: #dfe6e9; }
        .aura-active { background: #0984e3; box-shadow: 0 0 20px #0984e3; }

        /* Energy Bars */
        .power-bar-label { font-size: 0.75rem; font-weight: 600; color: #666; display: flex; justify-content: space-between; margin-bottom: 2px;}
        .progress { height: 8px; border-radius: 5px; background: #e0e0e0; margin-bottom: 10px; }
        .bar-happy { background: linear-gradient(90deg, #ffeaa7, #fdcb6e); }
        .bar-virtue { background: linear-gradient(90deg, #81ecec, #00cec9); }

        /* Inputs & Friend List */
        .mood-container { display: flex; justify-content: space-around; background: #fff; padding: 10px; border-radius: 20px; }
        .mood-btn { border: none; background: none; font-size: 2.2rem; opacity: 0.4; transition: 0.2s; filter: grayscale(1); }
        .mood-btn.active { opacity: 1; transform: scale(1.2); filter: grayscale(0); }
        .friend-list { max-height: 250px; overflow-y: auto; }
        .friend-item { display: flex; align-items: center; padding: 8px; border-radius: 12px; background: rgba(255,255,255,0.5); margin-bottom: 6px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .friend-item.selected { background: #fff; border-color: var(--primary); box-shadow: 0 2px 8px rgba(108, 92, 231, 0.2); }
        .friend-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover;}

        /* Feed / Stories Styling */
        .feed-card { background: #fff; border-radius: 20px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .feed-header { display: flex; align-items: center; margin-bottom: 10px; }
        .feed-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 2px solid #f0f0f0; }
        .feed-user h6 { margin: 0; font-weight: bold; font-size: 0.95rem; }
        .feed-user small { color: #999; font-size: 0.75rem; }
        .feed-img { width: 100%; border-radius: 12px; margin-bottom: 10px; display: block; object-fit: cover; max-height: 400px; background: #f8f9fa; cursor: pointer; }
        .feed-badge { background: rgba(108, 92, 231, 0.1); color: var(--primary); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
        .feed-content { font-size: 0.9rem; color: #555; line-height: 1.5; }
        .feed-actions { border-top: 1px solid #f0f0f0; margin-top: 10px; padding-top: 10px; display: flex; gap: 15px; }
        .action-btn { color: #aaa; font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
        .action-btn:hover { color: var(--accent); }
        .action-btn.liked { color: #ff7675; }

        /* Radar Chart */
        .radar-wrapper { position: relative; height: 320px; width: 320px; margin: 20px auto; }
        .radar-icon { position: absolute; width: 32px; height: 32px; background: #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1rem; color: #555; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .ri-top { top: 0; left: 50%; transform: translateX(-50%); color: #0984e3; } 
        .ri-tr  { top: 25%; right: 0; color: #6c5ce7; }
        .ri-br  { bottom: 15%; right: 5%; color: #fdcb6e; } 
        .ri-bl  { bottom: 15%; left: 5%; color: #ff7675; } 
        .ri-tl  { top: 25%; left: 0; color: #00b894; } 

        /* Manager Dashboard */
        .stat-card { background: #fff; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-num { font-size: 1.5rem; font-weight: bold; }
        .staff-row { cursor: pointer; transition: 0.2s; border-left: 5px solid transparent; }
        .staff-row:hover { background: #f8f9fa; transform: translateX(5px); }
        .status-critical { border-left-color: #ff7675; background: rgba(255, 118, 117, 0.05); }
        .status-warning { border-left-color: #ffeaa7; background: rgba(255, 234, 167, 0.1); }
        .status-normal { border-left-color: #55efc4; }
        .helper-avatar { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; margin-right: -10px; }

        /* Others */
        .img-preview-container { width: 100%; height: 200px; background-color: #f0f2f5; border-radius: 12px; margin-top: 10px; display: none; background-size: cover; background-position: center; border: 2px dashed #ccc; }
        .badge-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .badge-item { background: #fff; border-radius: 15px; padding: 15px 5px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .badge-item:hover { transform: translateY(-3px); }
        .badge-icon { font-size: 2rem; margin-bottom: 5px; }
        .info-btn { color: #aaa; cursor: pointer; margin-left: 5px; transition: 0.2s; }
        .info-btn:hover { color: var(--primary); }
        
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 450px; background: #fff; border-radius: 50px; padding: 10px; display: flex; justify-content: space-between; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 999; }
        .nav-item { text-align: center; flex: 1; color: #ccc; cursor: pointer; font-size: 1.2rem; transition: 0.3s; padding: 5px; border-radius: 20px; }
        .nav-item.active { color: var(--primary); background: rgba(108, 92, 231, 0.1); }
        .nav-item span { display: block; font-size: 0.6rem; margin-top: 2px; }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .page-section { display: none; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .badge-mystery-upgrade {
            background: linear-gradient(135deg, #a8e063, #56ab2f);
            color: white;
            animation: shakeBox 2s infinite;
            border: 2px solid #fff;
        }
        @keyframes shakeBox {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</p>
</div>

<div class="container mt-3">

    <div id="header-user" class="glass-card text-center pb-2">
        <div class="row align-items-center">
            <div class="col-4">
                <div class="profile-container">
                    <div id="userAura" class="aura-glow aura-active"></div>
                    <img id="userImg" src="https://via.placeholder.com/90" class="profile-img">
                </div>
            </div>
            <div class="col-8 text-start">
                <h4 id="userName" class="fw-bold mb-1">...</h4>
                <small id="userRole" class="text-muted d-block mb-2">...</small>
                <div class="power-bar-label"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç</span><i class="fas fa-bolt text-warning"></i></div>
                <div class="progress"><div class="progress-bar bar-happy" style="width: 80%"></div></div>
                <div class="power-bar-label"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</span><i class="fas fa-star text-info"></i></div>
                <div class="progress"><div class="progress-bar bar-virtue" style="width: 50%"></div></div>
            </div>
        </div>
    </div>

    <div id="page-record" class="page-section active">
        <div class="glass-card">
            <label class="form-label fw-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
            <div class="mood-container mb-3">
                <button class="mood-btn" onclick="setMood(1, this)">üòû</button>
                <button class="mood-btn" onclick="setMood(2, this)">üòê</button>
                <button class="mood-btn active" onclick="setMood(3, this)">üòÅ</button>
            </div>
            
            <label class="form-label fw-bold d-flex align-items-center">‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ <i class="fas fa-circle-question info-btn fa-lg" onclick="showVirtueInfo()"></i></label>
            <select class="form-select mb-3" id="virtueSelect" style="border-radius: 12px;">
                <option value="volunteer">ü§ù ‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤ (Volunteer)</option>
                <option value="sufficiency">üå± ‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á (Sufficiency)</option>
                <option value="discipline">üìè ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ (Discipline)</option>
                <option value="integrity">üíé ‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï (Integrity)</option>
                <option value="gratitude">üôè ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π (Gratitude)</option>
            </select>

            <div class="mb-3">
                <textarea class="form-control mb-2" rows="2" placeholder="‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤..." id="noteInput" style="border-radius: 12px;"></textarea>
                <div class="d-flex gap-2 overflow-auto pb-2">
                    <span class="badge bg-white text-dark border p-2" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                    <span class="badge bg-white text-dark border p-2" onclick="addEmoji('‚úåÔ∏è')">‚úåÔ∏è</span>
                    <span class="badge bg-white text-dark border p-2" onclick="addEmoji('üî•')">üî•</span>
                    <span class="badge bg-white text-dark border p-2" onclick="addEmoji('üôè')">üôè</span>
                </div>
                <button class="btn btn-outline-secondary w-100 rounded-3 mt-2" onclick="document.getElementById('fileCam').click()"><i class="fas fa-camera me-2"></i>‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</button>
                <input type="file" id="fileCam" hidden accept="image/*" onchange="previewImage(this)">
                <div id="previewArea" class="img-preview-container"></div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label fw-bold mb-0">‡∏ó‡∏≥‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£?</label>
                <button class="btn btn-sm btn-outline-primary rounded-pill px-3" id="btnSelectAll" onclick="selectAllFriends()"><i class="fas fa-check-double me-1"></i>All</button>
            </div>
            <div class="friend-list" id="friendListContainer"></div>
            <button class="btn btn-primary w-100 py-3 rounded-4 shadow mt-3 fw-bold" onclick="submitData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</button>
        </div>
    </div>

    <div id="page-stories" class="page-section">
        <h5 class="fw-bold mb-3 px-2">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
        <div id="feedContainer" style="min-height: 200px;">
            <div class="text-center py-5 text-muted">
                <div class="spinner-border spinner-border-sm mb-2"></div><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß...
            </div>
        </div>
    </div>

    <div id="page-stats" class="page-section">
        <div class="glass-card text-center">
            <h5 class="fw-bold">‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏û‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h5>
            <div class="radar-wrapper">
                <div class="radar-icon ri-top"><i class="fas fa-ruler-combined"></i></div>
                <div class="radar-icon ri-tr"><i class="fas fa-gem"></i></div>
                <div class="radar-icon ri-br"><i class="fas fa-hands-praying"></i></div>
                <div class="radar-icon ri-bl"><i class="fas fa-hand-holding-heart"></i></div>
                <div class="radar-icon ri-tl"><i class="fas fa-leaf"></i></div>
                <canvas id="userRadarChart"></canvas>
            </div>
        </div>
    </div>

    <div id="page-badges" class="page-section">
        <div class="glass-card">
            <h5 class="fw-bold mb-3"><i class="fas fa-medal text-warning me-2"></i>‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°</h5>
            <div class="badge-grid" id="badgeContainer"></div>
        </div>
    </div>

    <div id="page-manager" class="page-section">
        <div class="glass-card">
            <h5 class="fw-bold mb-3"><i class="fas fa-chart-line text-primary me-2"></i>Executive Dashboard</h5>
            <div class="row g-2 mb-3">
                <div class="col-6"><div class="stat-card"><div class="stat-num text-warning">88%</div><div class="stat-label">Happy Index</div></div></div>
                <div class="col-6"><div class="stat-card"><div class="stat-num text-info">--</div><div class="stat-label">Issues</div></div></div>
            </div>
            <div class="mb-4 position-relative">
                <small class="fw-bold text-muted">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç (4 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</small>
                <canvas id="managerLineChart" height="150"></canvas>
                <div id="trendAlert" class="badge bg-danger position-absolute top-0 end-0 mt-4" style="display:none;"><i class="fas fa-arrow-down"></i> ‡∏Ç‡∏≤‡∏•‡∏á</div>
            </div>
            <h6 class="fw-bold border-bottom pb-2 d-flex justify-content-between">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ <small class="text-muted" style="font-size:0.6rem">üî¥‡∏ß‡∏¥‡∏Å‡∏§‡∏ï üü†‡∏£‡∏∞‡∏ß‡∏±‡∏á üü¢‡∏õ‡∏Å‡∏ï‡∏¥</small></h6>
            <div id="staffListArea"></div>
        </div>
    </div>

</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('record', this)"><i class="fas fa-plus-circle"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></div>
    <div class="nav-item" onclick="switchTab('stories', this)"><i class="fas fa-images"></i><span>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß</span></div>
    <div class="nav-item" onclick="switchTab('stats', this)"><i class="fas fa-chart-pie"></i><span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span></div>
    <div class="nav-item" onclick="switchTab('badges', this)"><i class="fas fa-medal"></i><span>‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</span></div>
    <div class="nav-item" onclick="switchTab('manager', this)"><i class="fas fa-user-tie"></i><span>‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</span></div>
</div>

<script>
    // --- ‚ö†Ô∏è CONFIGURATION: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ö†Ô∏è ---
    const LIFF_ID = '2009069961-FRS5kHE4'; // ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxRvEyRoQaxOUWR_6pTslNmCrM7IiZTRYzDDUtPtDmrhGehUq6zQpfm9MKp_CYzVmrX/exec'; // ‡πÉ‡∏™‡πà URL ‡∏à‡∏≤‡∏Å Apps Script

    // --- üèÜ BADGE CONFIGURATION (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ---
    const badgeConfig = {
        'volunteer': {
            title: '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡πÉ‡∏à‡∏ö‡∏∏‡∏ç',
            levels: [
                { count: 3,  rank: 'I',   icon: 'ü§ù', desc: '‡∏ó‡∏≥‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
                { count: 10, rank: 'II',  icon: 'üíñ', desc: '‡∏ó‡∏≥‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡∏Ñ‡∏£‡∏ö 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
                { count: 30, rank: 'III', icon: 'üòá', desc: '‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ (30 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)' }
            ]
        },
        'discipline': {
            title: '‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡πÄ‡∏ß‡∏•‡∏≤',
            levels: [
                { count: 3,  rank: 'I',   icon: '‚è∞', desc: '‡∏°‡∏µ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
                { count: 15, rank: 'II',  icon: '‚öñÔ∏è', desc: '‡πÅ‡∏ö‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ (15 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)' }
            ]
        },
        'rich_score': {
            title: '‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ',
            source: 'score', // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°
            levels: [
                { count: 200,  rank: 'I',   icon: 'ü•â', desc: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° 200 ‡πÅ‡∏ï‡πâ‡∏°' },
                { count: 1000, rank: 'II',  icon: 'ü•à', desc: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° 1,000 ‡πÅ‡∏ï‡πâ‡∏°' },
                { count: 5000, rank: 'III', icon: 'ü•á', desc: '‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô (5,000 ‡πÅ‡∏ï‡πâ‡∏°)' }
            ]
        },
        'active_novice': {
            title: '‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô',
            source: 'total', // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏£‡∏ß‡∏°
            levels: [
                { count: 5, rank: 'üî•', icon: 'üèÉ', desc: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' }
            ]
        }
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ user ‡∏≠‡∏¢‡∏π‡πà Lv ‡πÑ‡∏´‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    function getCalculatedLevel(badgeKey, userStats, userScore) {
        const config = badgeConfig[badgeKey];
        if (!config) return 0;

        let currentCount = 0;
        if (config.source === 'score') {
            currentCount = userScore || 0;
        } else {
            currentCount = userStats[badgeKey] || 0;
        }

        let calculatedLevel = 0;
        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å Level ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏•‡∏á‡∏°‡∏≤
        for (let i = config.levels.length - 1; i >= 0; i--) {
            if (currentCount >= config.levels[i].count) {
                calculatedLevel = i + 1; // Level ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 1
                break;
            }
        }
        return calculatedLevel;
    }


    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ user ‡∏≠‡∏¢‡∏π‡πà Lv ‡πÑ‡∏´‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏£‡∏¥‡∏á ---
    function getCalculatedLevel(badgeKey, userStats, userScore, userTotal) {
        const config = badgeConfig[badgeKey];
        if (!config) return 0;

        let currentCount = 0;
        if (config.source === 'score') {
            currentCount = userScore || 0;
        } else if (config.source === 'total') {
            currentCount = userTotal || 0;
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ source ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å virtueStats (‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ)
            currentCount = userStats[badgeKey] || 0;
        }

        let calculatedLevel = 0;
        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å Level ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏•‡∏á‡∏°‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ Level ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå
        for (let i = config.levels.length - 1; i >= 0; i--) {
            if (currentCount >= config.levels[i].count) {
                calculatedLevel = i + 1; // Level ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 1
                break;
            }
        }
        return calculatedLevel;
    }


    // --- üéÅ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î) ---
    function renderBadges() {
        const container = document.getElementById('badgeContainer');
        if(!container || !currentUser) return;
        container.innerHTML = '';
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
        const myVirtueStats = currentUser.virtueStats || {};
        const myTotalScore = currentUser.score || 0;
        const myTotalCount = currentUser.totalCount || 0;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Level ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (Local Storage)
        let storageKey = `happyMeter_badges_${currentUser.userId}`;
        let storedLevels = JSON.parse(localStorage.getItem(storageKey)) || {};

        Object.keys(badgeConfig).forEach(badgeKey => {
            const config = badgeConfig[badgeKey];
            
            // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Level ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏£‡∏¥‡∏á
            const realLevelIdx = getCalculatedLevel(badgeKey, myVirtueStats, myTotalScore, myTotalCount);
            
            // 2. ‡∏î‡∏∂‡∏á Level ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÑ‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            const seenLevelIdx = storedLevels[badgeKey] || 0;

            let html = '';

            if (realLevelIdx === 0) {
                // CASE A: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Lv.1 (‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏°‡πà‡∏Å‡∏∏‡∏ç‡πÅ‡∏à üîí)
                html = `
                    <div class="badge-item badge-locked" onclick="viewBadge('${config.title}', '‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏±‡πâ‡∏ô‡πÅ‡∏£‡∏Å', 'üîí')">
                        <div class="badge-icon">üîí</div>
                        <small>${config.title}</small>
                    </div>`;

            } else if (realLevelIdx > seenLevelIdx) {
                // CASE B: ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î! (Level ‡∏à‡∏£‡∏¥‡∏á > Level ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏î‡∏π) -> ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏±‡πà‡∏ô üéÅ
                const nextLvConfig = config.levels[realLevelIdx - 1];
                html = `
                    <div class="badge-item badge-mystery-upgrade" onclick="revealUpgrade('${badgeKey}', ${realLevelIdx}, '${config.title} ${nextLvConfig.rank}', '${nextLvConfig.icon}')">
                        <div class="badge-icon">üéÅ</div>
                        <small>‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î!</small>
                    </div>`;

            } else {
                // CASE C: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç Level ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏Ñ‡∏¢‡∏î‡∏π‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ü•á)
                const currentLvConfig = config.levels[realLevelIdx - 1];
                html = `
                    <div class="badge-item" onclick="viewBadge('${config.title} ${currentLvConfig.rank}', '${currentLvConfig.desc}', '${currentLvConfig.icon}')">
                        <div class="badge-icon">${currentLvConfig.icon}</div>
                        <small>${config.title} ${currentLvConfig.rank}</small>
                    </div>`;
            }
            container.innerHTML += html;
        });
    }

    // --------------------------------------------------
    // üëáüëáüëá ‡∏ß‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö üëáüëáüëá
    // --------------------------------------------------

    // --- CORE FEATURES: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ---
    function fetchFriendsList() {
        // 1. ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
        if (!currentUser || !currentUser.userId) {
             console.warn("‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô...");
             return;
        }

        console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô...");
        fetch(`${GAS_URL}?action=get_users`)
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('friendListArea');
            if (!container) return; // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            container.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô
            
            let count = 0;
            data.forEach(user => {
                // üö® 2. ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤ Line ID ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°)
                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô String ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
                if (String(user.lineId) === String(currentUser.userId)) return;

                count++;
                const div = document.createElement('div');
                // ‡πÉ‡∏ä‡πâ class 'col-6' ‡∏Ç‡∏≠‡∏á Bootstrap ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á 2 ‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡πÅ‡∏ñ‡∏ß
                div.className = 'col-6 mb-2';
                div.innerHTML = `
                    <div class="friend-item p-2 border rounded d-flex align-items-center bg-white shadow-sm" style="cursor:pointer; transition: all 0.2s;" data-id="${user.lineId}" onclick="toggleFriend(this)">
                        <img src="${user.img || 'https://via.placeholder.com/35'}" class="rounded-circle me-2 border" width="35" height="35" style="object-fit:cover;">
                        <div class="text-truncate small fw-bold" style="max-width: 120px;">${user.name}</div>
                    </div>
                `;
                container.appendChild(div);
            });
            console.log(`‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${count} ‡∏Ñ‡∏ô (‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)`);

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            if (count === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted small py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>';
            }
        })
        .catch(err => console.error('Error fetching friends:', err));
    }
    // --------------------------------------------------
    // üëÜüëÜüëÜ ‡∏à‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà üëÜüëÜüëÜ
    // --------------------------------------------------
    // --- üéâ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î ---
    function revealUpgrade(badgeKey, newLevelIdx, title, icon) {
        // 1. ‡πÅ‡∏™‡∏î‡∏á Effect ‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏â‡∏•‡∏≠‡∏á
        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        Swal.fire({
            title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            text: `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç "${title}"`,
            // ‡πÉ‡∏ä‡πâ Dummy image ‡πÅ‡∏ó‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏™‡πà URL ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ)
            imageUrl: `https://dummyimage.com/200x200/eee/000&text=${icon}`, 
            imageWidth: 100, imageHeight: 100,
            confirmButtonColor: '#6c5ce7',
            confirmButtonText: '‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î!'
        }).then(() => {
            // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π Level ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß
            let storageKey = `happyMeter_badges_${currentUser.userId}`;
            let storedLevels = JSON.parse(localStorage.getItem(storageKey)) || {};
            storedLevels[badgeKey] = newLevelIdx;
            localStorage.setItem(storageKey, JSON.stringify(storedLevels));

            // 3. ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
            renderBadges();
        });
    }
    
    // Global Vars
    let currentUser = null;
    let selectedMood = 3;
    let selectedImageBase64 = null;
    let chartData = []; 

    // --- MAIN FUNCTION ---
    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { 
                liff.login(); 
                return; 
            }
            const profile = await liff.getProfile();
            await checkUser(profile.userId, profile);
        } catch (err) {
            console.error('LIFF Error:', err);
            activateDemoMode();
        }
    }

    // --- DEMO MODE ---
    function activateDemoMode() {
        console.warn('Entering Demo Mode');
        document.getElementById('loading').style.display = 'none';
        currentUser = { name: "Test User (PC)", role: "Admin", score: 999, level: 99, badges: ['badge_volunteer', 'badge_time'], img: "https://via.placeholder.com/90", userId: "U_TEST_1234" };
        renderProfile();
        switchTab('record', document.querySelector('.nav-item.active'));
        // ‡∏•‡∏ö Popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö
    }

    main();

    // --- USER LOGIC ---
    function checkUser(userId, profile) {
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'check_user', userId: userId }) })
        .then(res => res.json())
        .then(data => {
            if (data.exists) { 
                currentUser = { ...data.user, userId: userId }; 
                renderProfile(); 
                // ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏π‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£)
                fetchManagerData();
            } else { 
                registerUser(userId, profile); 
            }
            document.getElementById('loading').style.display = 'none';
        });
    }
    function registerUser(userId, profile) {
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'register_user', userId: userId, userName: profile.displayName, userImg: profile.pictureUrl }) })
        .then(() => checkUser(userId, profile));
    }

    function renderProfile() {
        if(!currentUser) return;

        document.getElementById('userName').innerText = currentUser.name;
        document.getElementById('userRole').innerHTML = `${currentUser.role || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'} ‚Ä¢ <span class="text-primary fw-bold">Lv.${currentUser.level || 1}</span>`;
        document.getElementById('userImg').src = currentUser.img || 'https://via.placeholder.com/90';
        initUserRadar();
        renderBadges();
    }

    // --- MANAGER FEATURES ---
    function renderStaffList(users) {
        const sList = document.getElementById('staffListArea');
        sList.innerHTML = '';
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç (‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
        users.sort((a,b) => {
            let happyA = (a.score % 10) + 1;
            let happyB = (b.score % 10) + 1;
            return happyA - happyB;
        });

        users.forEach(f => {
            let statusClass = 'status-normal', icon = 'üü¢';
            let happyScore = (f.score % 10) + 1; 
            if(happyScore < 5) { statusClass = 'status-critical'; icon = 'üî¥'; }
            else if(happyScore < 7) { statusClass = 'status-warning'; icon = 'üü†'; }
            
            // üëâ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°)
            let rescueActionHtml = '';
            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (‡∏™‡∏µ‡πÅ‡∏î‡∏á) ‡πÅ‡∏•‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡πÄ‡∏à‡∏≠
            if (statusClass === 'status-critical' && f.topCloseness) {
                rescueActionHtml = `
                    <div class="mt-2 p-2 bg-white border border-danger text-danger rounded shadow-sm fade-in d-flex align-items-center" style="border-left-width: 4px !important; font-size: 0.85rem;">
                        <span style="font-size: 1.2rem; margin-right: 8px;">ü§ñ</span>
                        <div>
                            <strong>System Action:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ <u>‡∏Ñ‡∏∏‡∏ì ${f.topCloseness.name}</u> (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó) ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡πÅ‡∏•‡∏î‡πà‡∏ß‡∏ô! üö®
                        </div>
                    </div>
                `;
            }

            const div = document.createElement('div');
            div.className = `p-2 staff-row border-bottom ${statusClass}`; // ‡πÄ‡∏≠‡∏≤ d-flex align-items-center ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î layout ‡πÅ‡∏ö‡∏ö column
            
            let closenessHtml = '';
            if (f.topCloseness) {
                closenessHtml = `<div class="mt-1" style="font-size:0.75rem; color:#888;"><i class="fas fa-user-friends me-1"></i> ‡∏™‡∏ô‡∏¥‡∏ó‡∏Å‡∏±‡∏ö: ${f.topCloseness.name} (${f.topCloseness.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>`;
            }

            // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            div.onclick = () => showStaffDetail(f, happyScore);
            
            // ‡∏à‡∏±‡∏î Layout ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á Rescue
            div.innerHTML = `
                <div class="d-flex align-items-start">
                    <img src="${f.img}" style="width:50px; height:50px; border-radius:50%; margin-right:12px; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold text-dark" style="font-size:1.05rem;">${f.name}</div>
                                <small class="text-muted badge bg-light text-dark border">${f.role}</small>
                            </div>
                            <div class="text-end">
                                 <span class="fw-bold" style="font-size:1.2rem;">${happyScore}</span> <small style="font-size:1rem;">${icon}</small>
                            </div>
                        </div>
                        ${closenessHtml}
                    </div>
                </div>
                ${rescueActionHtml} `;
            sList.appendChild(div);
        });
    }

    // --- üö® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Popup ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç ---
    function showRescuePopup(distressedName, friendName) {
        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏á‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó
        const helpMessage = `üÜò ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏î‡πà‡∏ß‡∏ô! \n\n‡∏£‡∏∞‡∏ö‡∏ö Happy Meter ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ "${distressedName}" ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ô‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á (Red Zone) üî¥ \n\n‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì "${friendName}" ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏¥‡∏ó‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∂‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡∏ù‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞! \n\n‡∏•‡∏≠‡∏á‡∏ó‡∏±‡∏Å‡πÑ‡∏õ‡∏Ñ‡∏∏‡∏¢ ‡∏ä‡∏ß‡∏ô‡πÑ‡∏õ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏≥‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏î‡∏π‡∏ô‡∏∞ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å! üôè \n\n#‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô #RedZoneRescue`;

        Swal.fire({
            title: '<span class="text-danger">üö® Red Zone Alert!</span>',
            html: `
                <div class="mb-3">‡∏Ñ‡∏∏‡∏ì <strong>${distressedName}</strong> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à</div>
                <div class="p-3 bg-light rounded mb-3">
                    <small class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∑‡∏≠:</small><br>
                    <strong class="text-primary" style="font-size:1.3rem;">ü§ù ‡∏Ñ‡∏∏‡∏ì ${friendName}</strong>
                </div>
                <p class="small text-muted">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${friendName} ‡∏ú‡πà‡∏≤‡∏ô LINE</p>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d63031',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '<i class="fab fa-line"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô',
            cancelButtonText: '‡∏õ‡∏¥‡∏î'
        }).then((result) => {
            if (result.isConfirmed) {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ LIFF Share Target Picker
                if (liff.isApiAvailable('shareTargetPicker')) {
                    liff.shareTargetPicker([
                        { type: "text", text: helpMessage }
                    ]).then((res) => {
                        if(res) Swal.fire('‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    }).catch((err) => {
                        console.error('Share Target Picker failed', err);
                        fallbackCopyText(helpMessage, friendName);
                    });
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏ô‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏ô
                    fallbackCopyText(helpMessage, friendName);
                }
            }
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
    function fallbackCopyText(text, friendName) {
        navigator.clipboard.writeText(text).then(() => {
             Swal.fire('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß', `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î LINE ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì "${friendName}" ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö`, 'info');
        }, () => {
             Swal.fire('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', text, 'info');
        });
    }
    
    // --- FEED LOGIC (STORIES) ---
    function fetchFeed() {
        const container = document.getElementById('feedContainer');
        if (!container) return;

        container.innerHTML = '<div class="text-center py-5 text-muted"><div class="spinner-border spinner-border-sm mb-2"></div><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';

        fetch(GAS_URL + '?action=get_feed')
        .then(res => {
            if (!res.ok) throw new Error("Server error: " + res.status);
            return res.json();
        })
        .then(feed => {
            container.innerHTML = '';
            if (!feed || feed.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted"><i class="far fa-newspaper fa-3x mb-3"></i><br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß<br>‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞!</div>';
                return;
            }
            feed.forEach(post => {
                let timeAgo = "-";
                try { timeAgo = new Date(post.timestamp).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' }); } catch(e) {}
                
                // Fix Mixed Content by replacing http with https for googleusercontent
                let imgUrl = post.image;
                if(imgUrl && imgUrl.startsWith('http:')) {
                    imgUrl = imgUrl.replace('http:', 'https:');
                }

                const imgHtml = (imgUrl && imgUrl.length > 10) ? `<img src="${imgUrl}" class="feed-img" onclick="viewImage('${imgUrl}')">` : '';
                const moodEmoji = post.happy == 3 ? 'üòÅ' : (post.happy == 2 ? 'üòê' : 'üòû');
                const html = `
                    <div class="glass-card feed-card p-3">
                        <div class="feed-header">
                            <img src="${post.user_img || 'https://via.placeholder.com/45'}" class="feed-avatar">
                            <div class="feed-user"><h6>${post.user_name}</h6><small>${timeAgo} ‚Ä¢ <span class="feed-badge">${post.virtue}</span></small></div>
                            <div class="ms-auto fs-4">${moodEmoji}</div>
                        </div>
                        <div class="feed-content mb-2">${post.note || ''}</div>
                        ${imgHtml}
                        <div class="feed-actions"><div class="action-btn" onclick="this.classList.toggle('liked'); this.querySelector('i').classList.toggle('fas'); this.querySelector('i').classList.toggle('far');"><i class="far fa-heart"></i> ‡∏ñ‡∏π‡∏Å‡πÉ‡∏à</div></div>
                    </div>`;
                container.innerHTML += html;
            });
        })
        .catch(err => {
            console.error(err);
            container.innerHTML = `<div class="alert alert-danger">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</div>`;
        });
    }
    
    function viewImage(url) {
        Swal.fire({ imageUrl: url, imageWidth: '100%', showConfirmButton: false, showCloseButton: true, background: 'transparent' });
    }

    // --- MANAGER FEATURES ---
    function renderStaffList(users) {
        const sList = document.getElementById('staffListArea');
        sList.innerHTML = '';
        users.sort((a,b) => a.score - b.score);
        users.forEach(f => {
            let statusClass = 'status-normal', icon = 'üü¢';
            let happyScore = (f.score % 10) + 1; 
            if(happyScore < 5) { statusClass = 'status-critical'; icon = 'üî¥'; }
            else if(happyScore < 7) { statusClass = 'status-warning'; icon = 'üü†'; }
            
            const div = document.createElement('div');
            div.className = `d-flex align-items-center p-2 staff-row border-bottom ${statusClass}`;
            div.onclick = () => showStaffDetail(f, happyScore);
            div.innerHTML = `<img src="${f.img}" style="width:40px; height:40px; border-radius:50%; margin-right:10px;"><div class="flex-grow-1"><div class="fw-bold text-dark" style="font-size:0.95rem;">${f.name}</div><small class="text-muted">${f.role}</small></div><div class="text-end"><span class="fw-bold">${happyScore}</span> <small>${icon}</small></div>`;
            sList.appendChild(div);
        });
    }

    function checkTrendAndSuggest() {
        const last = chartData[chartData.length - 1];
        const prev = chartData[chartData.length - 2];
        if (last < prev) {
            document.getElementById('trendAlert').style.display = 'block';
            Swal.fire({ title: '‚ö†Ô∏è ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ç‡∏≤‡∏•‡∏á', html: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏°‡∏ß‡∏•‡∏£‡∏ß‡∏°‡∏•‡∏î‡∏•‡∏á<br>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Team Building ‡∏î‡πà‡∏ß‡∏ô', icon: 'warning', confirmButtonColor: '#ff7675' });
        }
    }

    function showStaffDetail(user, score) {
        let helperHtml = (score < 7) ? `<div class="mt-3 bg-light p-2 rounded text-start"><small class="text-danger">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡πÅ‡∏•</small><button class="btn btn-sm btn-outline-danger w-100 mt-2">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button></div>` : `<div class="mt-3 bg-light p-2 rounded text-start"><small class="text-success">‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡πÅ‡∏•‡πÅ‡∏•‡πâ‡∏ß</small></div>`;
        Swal.fire({ html: `<img src="${user.img}" style="width:90px; height:90px; border-radius:50%; margin-bottom:10px;"><br><h5 class="fw-bold">${user.name}</h5><span class="badge bg-secondary mb-3">${user.role}</span><div class="row g-2 text-center"><div class="col-6"><div class="border rounded p-2"><h6>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç</h6><span class="${score<5?'text-danger':''}">${score}/10</span></div></div><div class="col-6"><div class="border rounded p-2"><h6>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°</h6><span>${user.score}</span></div></div></div>${helperHtml}`, showConfirmButton: false, showCloseButton: true });
    }

    // --- FORM & SUBMIT ---
    function setMood(val, btn) {
        selectedMood = val; // ‚úÖ ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        console.log("Selected mood set to:", selectedMood); // Debug
    }
    function addEmoji(emoji) { document.getElementById('noteInput').value += emoji + ' '; }
    
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800; const MAX_HEIGHT = 800;
                    let width = img.width; let height = img.height;
                    if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } 
                    else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    selectedImageBase64 = canvas.toDataURL('image/jpeg', 0.7); 
                    const preview = document.getElementById('previewArea');
                    preview.style.backgroundImage = `url(${selectedImageBase64})`;
                    preview.style.display = 'block';
                };
            }
            reader.readAsDataURL(file);
        }
    }

    function selectAllFriends() {
        const items = document.querySelectorAll('.friend-item');
        const btn = document.getElementById('btnSelectAll');
        const isSelect = btn.innerHTML.includes('All');
        items.forEach(i => isSelect ? i.classList.add('selected') : i.classList.remove('selected'));
        btn.innerHTML = isSelect ? '<i class="fas fa-times me-1"></i>Cancel' : '<i class="fas fa-check-double me-1"></i>All';
        btn.classList.toggle('btn-outline-primary'); btn.classList.toggle('btn-outline-danger');
    }

    async function submitData() {
        if(!currentUser) return Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');
        const btn = document.querySelector('button[onclick="submitData()"]');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
        try {
            const tagged = Array.from(document.querySelectorAll('.friend-item.selected')).map(el => el.dataset.id).join(',');
            let uploadId = null; let totalChunks = 0;
            if (selectedImageBase64) {
                uploadId = Date.now().toString();
                const CHUNK_SIZE = 50000;
                totalChunks = Math.ceil(selectedImageBase64.length / CHUNK_SIZE);
                for (let i = 0; i < totalChunks; i++) {
                    const chunk = selectedImageBase64.substring(i * CHUNK_SIZE, Math.min((i + 1) * CHUNK_SIZE, selectedImageBase64.length));
                    btn.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ${Math.round(((i+1)/totalChunks)*100)}%`;
                    await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'upload_chunk', uploadId: uploadId, chunkIndex: i, chunkData: chunk }) });
                }
            }
            btn.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            
            console.log("Submitting mood:", selectedMood); // Debug Check
            
            // ‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ selectedMood ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ
            await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ 
                action: 'submit_activity', 
                userId: currentUser.userId, 
                userName: currentUser.name, 
                happyLevel: selectedMood, // <-- ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ
                virtueTag: document.getElementById('virtueSelect').value, 
                note: document.getElementById('noteInput').value, 
                taggedFriends: tagged, 
                uploadId: uploadId, 
                totalChunks: totalChunks 
            }) });
            Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç', showConfirmButton: false, timer: 2000 }).then(() => { location.reload(); });
        } catch (err) { /* ... (error handling) ... */ }
    }
    // --- NAVIGATION ---
    function switchTab(pageId, el) {
        if (pageId === 'manager') {
            if (!currentUser || (currentUser.role !== 'Manager' && currentUser.role !== 'Admin')) {
                Swal.fire({ icon: 'error', title: 'Access Denied', text: '‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', confirmButtonColor: '#6c5ce7' });
                return;
            }
        }
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('header-user').style.display = (pageId === 'manager') ? 'none' : 'block';
        if(pageId === 'manager') fetchManagerData();
        if(pageId === 'stories') fetchFeed();
    }

    // --- CHARTS & UI UTILS ---
    function initUserRadar() {
        new Chart(document.getElementById('userRadarChart'), { type: 'radar', data: { labels: ['‡∏ß‡∏¥‡∏ô‡∏±‡∏¢', '‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï', '‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π', '‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤', '‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á'], datasets: [{ data: [9, 8, 6, 7, 5], backgroundColor: 'rgba(108, 92, 231, 0.4)', borderColor: '#6c5ce7' }] }, options: { maintainAspectRatio: false, scales: { r: { ticks: { display: false }, pointLabels: { display: false } } }, plugins: { legend: { display: false } } } });
    }
    function renderManagerChart() {
        const ctx = document.getElementById('managerLineChart');
        new Chart(ctx, { type: 'line', data: { labels: ['W1', 'W2', 'W3', 'W4'], datasets: [{ label: 'Happy Trend', data: chartData, borderColor: '#ff7675', backgroundColor: 'rgba(255, 118, 117, 0.1)', fill: true, tension: 0.4 }] }, options: { plugins: { legend: { display: false } }, scales: { y: { min: 5, max: 10 } } } });
    }
    function showVirtueInfo() { Swal.fire({ title: '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ', html: '<div class="text-start fs-6"><p><b class="text-danger">ü§ù ‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤:</b> ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô</p><p><b class="text-success">üå± ‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á:</b> ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î</p><p><b class="text-primary">üìè ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢:</b> ‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤</p><p><b style="color:#6c5ce7">üíé ‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï:</b> ‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå</p><p><b class="text-warning">üôè ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π:</b> ‡∏£‡∏π‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏ô</p></div>', confirmButtonColor: '#6c5ce7' }); }
    function openMysteryBox() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); Swal.fire({ title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!', imageUrl: 'https://cdn-icons-png.flaticon.com/512/2583/2583344.png', imageWidth: 100, imageHeight: 100, confirmButtonColor: '#6c5ce7' }); }
    function viewBadge(t,d,i) { Swal.fire({ title: i + ' ' + t, text: d, confirmButtonColor: '#6c5ce7' }); }

</script>
</body>
</html>







